<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ERP CTRFAM | Gesti√≥n Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
    :root { --bg:#09090b; --card:#18181b; --text:#fafafa; --gray:#a1a1aa; --green:#22c55e; --red:#ef4444; --blue:#3b82f6; --yellow:#eab308; --border:#27272a; --cyan:#06b6d4; --purple:#8b5cf6; }
    body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; margin:0; padding:20px; height:100vh; box-sizing:border-box; display:flex; flex-direction:column; overflow:hidden; }
    
    /* MODALS */
    #login-overlay, #admin-overlay, #reporte-overlay, #proyecto-overlay, #traspaso-overlay, #modal, #arqueo-overlay { 
        position:fixed; top:0; left:0; width:100vw; height:100vh; 
        background:rgba(0,0,0,0.85); backdrop-filter:blur(5px); z-index:99999; 
        display:none; justify-content:center; align-items:center; 
    }
    
    .login-box { width:300px; text-align:center; }
    .admin-box, .reporte-box, .proyecto-box, .modal-box { width:95%; max-width:600px; max-height:90vh; background:#111; border:1px solid #333; border-radius:15px; padding:25px; display:flex; flex-direction:column; overflow-y:auto; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .reporte-box { max-width:900px; }
    
    .login-input { width:100%; padding:15px; background:#222; border:1px solid #333; color:#fff; margin-bottom:10px; border-radius:8px; font-size:16px; text-align:center; outline:none; transition:0.3s; }
    .login-input:focus { border-color:var(--green); }
    
    /* LAYOUT & CARDS */
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:var(--card); padding:15px; border-radius:12px; border:1px solid var(--border); }
    .grid { display:grid; grid-template-columns: 350px 1fr 400px; gap:20px; height:100%; overflow:hidden; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); }
    
    .card-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:15px; margin-bottom:15px; }
    h2 { font-size:14px; color:var(--gray); text-transform:uppercase; margin:0; letter-spacing:1px; font-weight:600; }
    .big-number { font-size:28px; font-weight:700; color:#fff; }
    
    /* BOTONES */
    .btn { border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; display:flex; justify-content:center; align-items:center; gap:8px; transition:0.2s; text-transform:uppercase; letter-spacing:0.5px; }
    .btn:hover { transform:translateY(-1px); filter:brightness(1.1); }
    .btn:active { transform:translateY(1px); }
    .btn-green { background:var(--green); color:#000; } 
    .btn-red { background:rgba(239, 68, 68, 0.15); color:var(--red); border:1px solid var(--red); }
    .btn-blue { background:rgba(59, 130, 246, 0.15); color:var(--blue); border:1px solid var(--blue); }
    .btn-cyan { background:var(--cyan); color:#000; }
    .btn-gold { background:var(--yellow); color:#000; }
    .btn-purple { background:var(--purple); color:#fff; }
    .btn-small { padding:6px 10px; font-size:11px; }
    
    /* OTROS */
    .editable-item { display:flex; justify-content:space-between; align-items:center; background:#222; padding:12px; border-radius:8px; margin-bottom:10px; border:1px solid #333; }
    .editable-actions { display:flex; gap:5px; opacity:0; transition:0.3s; }
    .editable-item:hover .editable-actions { opacity:1; }
    input, select { width:100%; padding:12px; background:#000; border:1px solid #333; color:#fff; border-radius:6px; margin-bottom:15px; box-sizing:border-box; outline:none; }
    .form-row { display:flex; gap:10px; }
    ul { list-style:none; padding:0; margin:0; overflow-y:auto; flex:1; }
    li { display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222; align-items:center; }
    .meta-info { font-size:11px; color:#666; display:block; margin-top:4px; }

    /* PDF ESTILOS */
    #reporte-imprimible { display: none; background: white; color: black; padding: 40px; font-family: 'Helvetica', sans-serif; }
    .pdf-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 20px; }
    .pdf-logo { font-size: 24px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; }
    .pdf-sub { font-size: 12px; color: #555; margin-top: 5px; }
    .pdf-grid { display: flex; gap: 20px; margin-bottom: 30px; }
    .pdf-card { flex: 1; background: #f4f4f5; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #ddd; }
    .pdf-card h3 { margin: 0 0 5px 0; font-size: 12px; color: #666; text-transform: uppercase; }
    .pdf-card .val { font-size: 18px; font-weight: bold; }
    .pdf-table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .pdf-table th { background: #000; color: #fff; padding: 8px; text-align: left; }
    .pdf-table td { border-bottom: 1px solid #ddd; padding: 8px; }
    .pdf-table tr:nth-child(even) { background: #f9f9f9; }
    .ingreso-txt { color: #16a34a; font-weight: bold; }
    .gasto-txt { color: #dc2626; font-weight: bold; }

    .checkbox-wrapper { display:flex; align-items:center; gap:10px; margin-bottom:15px; padding:10px; background:#222; border-radius:6px; }
    @media (max-width: 1200px) { .grid { grid-template-columns:1fr; grid-template-rows: auto auto auto; overflow-y:auto; } body { overflow-y:auto; height:auto; } }
</style>
</head>
<body>

<div id="reporte-imprimible">
    <div class="pdf-header">
        <div class="pdf-logo">ERP CTRFAM</div>
        <div class="pdf-sub">Reporte Financiero Ejecutivo</div>
        <div class="pdf-sub" id="pdf-fecha"></div>
        <div class="pdf-sub" id="pdf-usuario"></div>
    </div>
    <div class="pdf-grid">
        <div class="pdf-card"><h3>Ingresos Totales</h3><div class="val ingreso-txt" id="pdf-ing"></div></div>
        <div class="pdf-card"><h3>Gastos Totales</h3><div class="val gasto-txt" id="pdf-gas"></div></div>
        <div class="pdf-card"><h3>Utilidad Neta</h3><div class="val" id="pdf-net"></div></div>
    </div>
    <h4 style="border-bottom: 1px solid #000; padding-bottom: 5px; margin-bottom: 10px;">Detalle de Movimientos</h4>
    <table class="pdf-table">
        <thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Proyecto</th><th>Cuenta</th><th>Monto</th></tr></thead>
        <tbody id="pdf-tabla-body"></tbody>
    </table>
</div>

<div id="login-overlay" style="display:flex;">
    <div class="login-box">
        <div style="font-size:50px; margin-bottom:20px;">üõ°Ô∏è</div>
        <h2 style="border:none; color:#fff; letter-spacing:2px; margin-bottom:30px;">ACCESO SEGURO</h2>
        <input type="text" id="user" class="login-input" placeholder="Usuario">
        <input type="password" id="pass" class="login-input" placeholder="Contrase√±a">
        <button class="btn btn-green" style="width:100%; margin-top:20px;" onclick="doLogin()">ENTRAR AL SISTEMA</button>
        <p id="loginError" style="color:var(--red); font-size:12px; display:none; margin-top:10px;">Credenciales incorrectas</p>
    </div>
</div>

<div id="admin-overlay">
    <div class="admin-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 style="border:none; color:#fff; margin:0;">üë• Gesti√≥n de Personal</h2>
            <button class="btn btn-red btn-small" onclick="$('admin-overlay').style.display='none'">CERRAR</button>
        </div>
        <div style="background:#222; padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid #333;">
            <h3 style="margin:0 0 15px 0; font-size:12px; color:var(--gray);" id="userModalTitle">NUEVO COLABORADOR</h3>
            <input type="hidden" id="userIdEdit">
            <input type="text" id="new_fullname" placeholder="Nombre Completo">
            <input type="text" id="new_user" placeholder="Usuario">
            <input type="text" id="new_pass" placeholder="Contrase√±a (Dejar en blanco si no cambia)">
            <div style="font-size:12px; margin-bottom:10px; color:#aaa;">Proyectos Permitidos:</div>
            <div id="checklistProyectos" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;"></div>
            <button class="btn btn-blue" style="width:100%" onclick="guardarUsuario()">GUARDAR CAMBIOS</button>
        </div>
        <div style="flex:1;"><h3 style="margin:0 0 15px 0; font-size:12px; color:var(--gray);">EQUIPO ACTUAL</h3><ul id="listaUsuarios"></ul></div>
    </div>
</div>

<div id="proyecto-overlay">
    <div class="proyecto-box">
        <h2 style="color:#fff; border:none; margin-bottom:20px;" id="proyModalTitle">Configurar Proyecto</h2>
        <input type="hidden" id="proyIdEdit">
        <label style="font-size:12px; color:#aaa;">Nombre del Proyecto</label>
        <input type="text" id="proyNombre" placeholder="Ej. Yayika ML">
        <label style="color:var(--yellow); font-size:12px; margin-bottom:10px; display:block;">CUENTAS VINCULADAS (Para que el usuario las vea)</label>
        <div id="checklistCuentasProy" style="background:#222; padding:15px; border-radius:8px; display:grid; grid-template-columns:1fr; gap:10px; margin-bottom:20px; border:1px solid #333;"></div>
        <div class="form-row"><button class="btn btn-green" style="flex:1" onclick="guardarActivoFull()">GUARDAR</button><button class="btn btn-red" style="flex:1" onclick="$('proyecto-overlay').style.display='none'">CANCELAR</button></div>
    </div>
</div>

<div id="traspaso-overlay">
    <div class="modal-box">
        <h2 style="color:#fff; border:none; margin-bottom:20px;">Transferencia entre Cuentas</h2>
        <label style="font-size:12px; color:#aaa;">Monto ($)</label><input type="number" id="trasMonto" placeholder="0.00">
        <label style="font-size:12px; color:#aaa;">Origen (Sale)</label><select id="trasOrigen"></select>
        <label style="font-size:12px; color:#aaa;">Destino (Entra)</label><select id="trasDestino"></select>
        <label style="font-size:12px; color:#aaa;">Proyecto Asociado</label><select id="trasProyecto"></select>
        <label style="font-size:12px; color:#aaa;">Referencia</label><input type="text" id="trasDesc" placeholder="Ej. Ganancias ML">
        <div class="form-row" style="margin-top:20px;">
            <button class="btn btn-cyan" style="flex:1" onclick="ejecutarTraspaso()">CONFIRMAR</button>
            <button class="btn btn-red" style="flex:1" onclick="$('traspaso-overlay').style.display='none'">CANCELAR</button>
        </div>
    </div>
</div>

<div id="arqueo-overlay">
    <div class="modal-box">
        <h2 style="color:#fff; border:none; margin-bottom:20px;">üßÆ Calculadora de Arqueo</h2>
        <div style="font-size:12px; color:#aaa; margin-bottom:15px;">Selecciona las cuentas para sumar sus saldos:</div>
        <div id="listaArqueo" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>
        <div style="background:#222; padding:15px; border-radius:10px; text-align:center; border:1px solid #444;">
            <div style="font-size:12px; color:#aaa;">TOTAL SELECCIONADO</div>
            <div style="font-size:30px; font-weight:bold; color:var(--green);" id="totalArqueo">$0.00</div>
        </div>
        <button class="btn btn-red" style="width:100%; margin-top:20px;" onclick="$('arqueo-overlay').style.display='none'">CERRAR</button>
    </div>
</div>

<div id="reporte-overlay">
    <div class="reporte-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="border:none; margin:0; font-size:20px; color:#fff;">üìä Reportes Ejecutivos</h2>
            <div style="display:flex; gap:10px;"><button class="btn btn-gold" onclick="descargarPDF()">üì• DESCARGAR PDF</button><button class="btn btn-red" onclick="cerrarReportes()">CERRAR</button></div>
        </div>
        <div class="filter-bar">
            <select id="filtroAnio" class="filter-select" onchange="actualizarReporte()"><option value="2026">2026</option><option value="2025">2025</option></select>
            <select id="filtroMes" class="filter-select" onchange="actualizarReporte()"><option value="todos">Todo el A√±o</option><option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option></select>
            <select id="filtroProyecto" class="filter-select" onchange="actualizarReporte()"><option value="todos">Todos mis Proyectos</option></select>
        </div>
        <div style="display:flex; gap:20px; margin-bottom:20px;">
            <div class="card" style="flex:1; text-align:center; padding:15px;"><div style="color:var(--green); font-size:12px; font-weight:bold;">INGRESOS</div><div id="repIng" style="font-size:24px; font-weight:bold;">$0.00</div></div>
            <div class="card" style="flex:1; text-align:center; padding:15px;"><div style="color:var(--red); font-size:12px; font-weight:bold;">GASTOS</div><div id="repGas" style="font-size:24px; font-weight:bold;">$0.00</div></div>
            <div class="card" style="flex:1; text-align:center; padding:15px;"><div style="color:#fff; font-size:12px; font-weight:bold;">UTILIDAD</div><div id="repNeto" style="font-size:24px; font-weight:bold;">$0.00</div></div>
        </div>
        <div style="flex:1; position:relative; min-height:300px;"><canvas id="chartReporteMain"></canvas></div>
    </div>
</div>

<div id="modal">
    <div class="modal-box">
        <h2 id="modalTitle" style="color:var(--text); border:none; margin-bottom:20px;">Registrar Movimiento</h2>
        <label style="font-size:12px; color:#aaa;">Concepto</label><input type="text" id="desc" placeholder="Ej. Pago de n√≥mina">
        <div class="form-row"><div style="flex:1"><label style="font-size:12px; color:#aaa;">Monto ($)</label><input type="number" id="monto"></div><div style="flex:1"><label style="font-size:12px; color:#aaa;">Tipo</label><input type="text" id="tipoTxt" readonly style="color:#888;"></div></div>
        <div id="divReembolso" class="checkbox-wrapper" style="display:none;"><input type="checkbox" id="chkReembolso" style="width:auto; margin:0;"><label for="chkReembolso" style="color:var(--yellow); font-size:12px; margin:0;">‚ö†Ô∏è Pendiente de Reembolso</label></div>
        <label style="font-size:12px; color:#aaa;">Cuenta de Origen/Destino</label><select id="selCuenta"></select>
        <label style="font-size:12px; color:#aaa;">Proyecto Asociado</label><select id="selActivo"></select>
        <div class="form-row" style="margin-top:20px;"><button class="btn btn-green" style="flex:1" onclick="guardarMovimiento()">CONFIRMAR</button><button class="btn btn-red" style="flex:1" onclick="closeModal()">CANCELAR</button></div>
    </div>
</div>

<div class="top-bar">
    <div>
        <div style="font-size:11px; color:var(--gray); font-weight:600; letter-spacing:1px;">PATRIMONIO TOTAL</div>
        <div class="big-number" id="totalPatrimonio">---</div>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="btn btn-cyan" onclick="abrirTraspaso()">‚áÑ TRASPASO</button>
        <button class="btn btn-gold" id="btnReportes" style="display:none;" onclick="abrirReportes()">üìä REPORTES</button>
        <button class="btn btn-blue" id="btnAdmin" style="display:none;" onclick="abrirAdmin()">‚öôÔ∏è PERSONAL</button>
        <button class="btn btn-green" onclick="openModal('ingreso')">‚¨Ü INGRESAR</button>
        <button class="btn btn-red" onclick="openModal('gasto')">‚¨á GASTAR</button>
        <button class="btn" style="background:#333; color:#fff;" onclick="logout()">üîì SALIR</button>
    </div>
</div>

<div id="radar-alertas"></div>

<div class="grid">
    <div class="card">
        <div class="card-header">
            <h2>üè¶ Cuentas</h2>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-purple btn-small" onclick="abrirArqueo()">üßÆ CUADRAR</button>
                <button class="btn btn-blue btn-small" id="btnAddCta" style="display:none;" onclick="crearCuenta()">+ CREAR</button>
            </div>
        </div>
        <div id="listCuentas"></div>
    </div>
    <div class="card">
        <div class="card-header"><h2>üöÄ Proyectos</h2><button class="btn btn-blue btn-small" id="btnAddProy" style="display:none;" onclick="abrirModalProyecto()">+ CREAR</button></div>
        <div style="display:grid; grid-template-columns:1fr; gap:10px; margin-bottom:15px;" id="gridActivos"></div>
        <div style="flex:1; border-top:1px solid #222; padding-top:10px;"><canvas id="chartActivos"></canvas></div>
    </div>
    <div class="card">
        <div class="card-header"><h2>üìù √öltimos Movimientos</h2></div>
        <ul id="listMovs"></ul>
    </div>
</div>

<script>
const $ = id => document.getElementById(id);
let DATA = { cuentas:[], activos:[], movimientos:[], pendientes:[] };
let CURRENT_USER = '';
let IS_ADMIN = false;
let currentTipo = 'ingreso';
let chartRef, reportChartRef;
let REPORT_DATA_CACHE = null;
let ALL_USERS = [];

async function doLogin() {
    const user = $('user').value; const pass = $('pass').value;
    try { const res = await fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user,pass})}); const data = await res.json(); if (data.success) { CURRENT_USER = data.user; IS_ADMIN = data.es_admin; $('login-overlay').style.display='none'; loadData(); } else { $('loginError').style.display='block'; } } catch(e) { alert("Error Conexi√≥n"); }
}
function logout() { location.reload(); }

async function loadData() { try { const res = await fetch(`/api/data?user=${CURRENT_USER}`); DATA = await res.json(); renderAll(); populateFilters(); } catch(e) { console.error("Error cargando"); } }

function renderAll() {
    $('btnReportes').style.display = 'flex'; $('totalPatrimonio').innerText = fmtMoney(DATA.patrimonio);
    if(IS_ADMIN) { $('btnAdmin').style.display = 'flex'; $('btnAddProy').style.display = 'block'; $('btnAddCta').style.display = 'block'; } else { $('btnAdmin').style.display = 'none'; $('btnAddProy').style.display = 'none'; $('btnAddCta').style.display = 'none'; }
    const radar = $('radar-alertas'); radar.innerHTML = '';
    if(DATA.pendientes && DATA.pendientes.length > 0) { radar.style.display = 'flex'; DATA.pendientes.forEach(m => { const item = document.createElement('div'); item.className = 'alerta-item'; item.innerHTML = `<div><strong>‚ö†Ô∏è REEMBOLSO PENDIENTE: ${fmtMoney(Math.abs(m.monto))}</strong><br><span style="font-size:11px;">${m.descripcion} (${m.activo_id?.nombre})</span></div><button class="btn btn-green btn-small" onclick="confirmarReembolso('${m._id}')">‚úÖ LLEG√ì</button>`; radar.appendChild(item); }); } else { radar.style.display = 'none'; }
    $('listCuentas').innerHTML = DATA.cuentas.map(c => `<div class="editable-item"><div><span>${c.icono} ${c.nombre}</span> <span style="font-weight:bold; margin-left:10px;">${fmtMoney(c.saldo)}</span></div>${IS_ADMIN ? `<div class="editable-actions"><button class="btn btn-blue btn-small" onclick="editarCuenta('${c._id}','${c.nombre}')">‚úèÔ∏è</button><button class="btn btn-red btn-small" onclick="borrarCuenta('${c._id}')">üóëÔ∏è</button></div>` : ''}</div>`).join('');
    $('gridActivos').innerHTML = DATA.activos.map(a => `<div class="editable-item" style="background:#151515; border:1px solid #333;"><div style="flex:1;"><div style="font-size:11px; color:#888;">${a.icono} ${a.nombre}</div><div style="font-size:15px; font-weight:bold; color:${a.balance_total>=0?'var(--green)':'var(--red)'}">${fmtMoney(a.balance_total)}</div></div>${IS_ADMIN ? `<div class="editable-actions"><button class="btn btn-blue btn-small" onclick="abrirModalProyecto('${a._id}')">‚úèÔ∏è</button><button class="btn btn-red btn-small" onclick="borrarActivo('${a._id}')">üóëÔ∏è</button></div>` : ''}</div>`).join('');
    $('listMovs').innerHTML = DATA.movimientos.map(m => { 
        let color = m.tipo=='ingreso'?'var(--green)':'var(--red)'; 
        if(m.estado === 'pendiente_reembolso') color = 'var(--yellow)'; 
        if(m.estado === 'reembolsado') color = '#555';
        if(m.tipo.includes('traspaso')) color = 'var(--cyan)';
        return `<li style="opacity:${m.estado==='reembolsado'?0.5:1}"><div><span style="display:block; font-size:13px; font-weight:600;">${m.descripcion}</span><span class="meta-info">üë§ ${m.creado_por} | üìÇ ${m.activo_id?m.activo_id.nombre:'General'}</span></div><span style="font-weight:bold; color:${color}">${m.tipo=='ingreso'?'+':''}${fmtMoney(m.monto)}</span></li>` 
    }).join('');
    updateChart(); populateSelects();
}

// ARQUEO / CALCULADORA
function abrirArqueo() {
    $('arqueo-overlay').style.display='flex';
    $('listaArqueo').innerHTML = DATA.cuentas.map(c => `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #222;">
            <div style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox" class="chk-arqueo" value="${c.saldo}" onchange="calcularArqueo()">
                <span>${c.icono} ${c.nombre}</span>
            </div>
            <span>${fmtMoney(c.saldo)}</span>
        </div>
    `).join('');
    calcularArqueo();
}
function calcularArqueo() {
    let total = 0;
    document.querySelectorAll('.chk-arqueo:checked').forEach(chk => { total += parseFloat(chk.value); });
    $('totalArqueo').innerText = fmtMoney(total);
}

// TRASPASOS & REPORTES & CRUD (IGUAL A V9 PERO MANTENIENDO TODO FUNCIONAL)
function abrirTraspaso() {
    $('traspaso-overlay').style.display = 'flex'; const opts = DATA.cuentas.map(c => `<option value="${c._id}">${c.nombre} ($${c.saldo})</option>`).join('');
    $('trasOrigen').innerHTML = opts; $('trasDestino').innerHTML = opts; $('trasProyecto').innerHTML = DATA.activos.map(a => `<option value="${a._id}">${a.nombre}</option>`).join('');
}
async function ejecutarTraspaso() {
    const o = $('trasOrigen').value; const d = $('trasDestino').value; const m = $('trasMonto').value; const desc = $('trasDesc').value; const p = $('trasProyecto').value;
    if(!o || !d || !m || !p) return alert("Faltan datos"); if(o === d) return alert("Origen y Destino iguales");
    await fetch('/api/traspaso', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({origen_id:o, destino_id:d, monto:m, descripcion:desc, usuario_actual:CURRENT_USER, activo_id:p})});
    $('traspaso-overlay').style.display='none'; loadData();
}
function abrirReportes() { $('reporte-overlay').style.display = 'flex'; actualizarReporte(); }
function cerrarReportes() { $('reporte-overlay').style.display = 'none'; }
function populateFilters() { $('filtroProyecto').innerHTML = '<option value="todos">Todos mis Proyectos</option>' + DATA.activos.map(a => `<option value="${a._id}">${a.nombre}</option>`).join(''); }
async function actualizarReporte() {
    const anio = $('filtroAnio').value; const mes = $('filtroMes').value; const activo_id = $('filtroProyecto').value;
    const res = await fetch('/api/reporte', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ anio, mes, activo_id, user: CURRENT_USER }) });
    const reporte = await res.json(); REPORT_DATA_CACHE = reporte;
    $('repIng').innerText = fmtMoney(reporte.ingresos); $('repGas').innerText = fmtMoney(reporte.gastos); $('repNeto').innerText = fmtMoney(reporte.neto); $('repNeto').style.color = reporte.neto >= 0 ? 'var(--green)' : 'var(--red)';
    const ctx = $('chartReporteMain').getContext('2d'); if(reportChartRef) reportChartRef.destroy();
    reportChartRef = new Chart(ctx, { type: 'bar', data: { labels: ['Ingresos', 'Gastos', 'Neto'], datasets: [{ label: 'Flujo', data: [reporte.ingresos, reporte.gastos, reporte.neto], backgroundColor: ['#22c55e', '#ef4444', '#3b82f6'], borderRadius:5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#333' } }, x: { grid: { display: false } } } } });
}
function descargarPDF() {
    if (!REPORT_DATA_CACHE) return alert("Carga reporte"); $('pdf-fecha').innerText = "Fecha: " + new Date().toLocaleDateString(); $('pdf-usuario').innerText = "Usuario: " + CURRENT_USER;
    $('pdf-ing').innerText = fmtMoney(REPORT_DATA_CACHE.ingresos); $('pdf-gas').innerText = fmtMoney(REPORT_DATA_CACHE.gastos); $('pdf-net').innerText = fmtMoney(REPORT_DATA_CACHE.neto);
    const tbody = $('pdf-tabla-body'); tbody.innerHTML = '';
    if(REPORT_DATA_CACHE.detalles) { REPORT_DATA_CACHE.detalles.forEach(m => { const tr = document.createElement('tr'); const color = m.tipo === 'ingreso' ? 'green' : 'red'; tr.innerHTML = `<td>${new Date(m.fecha).toLocaleDateString()}</td><td>${m.descripcion}</td><td>${m.activo_id ? m.activo_id.nombre : '-'}</td><td>${m.cuenta_id ? m.cuenta_id.nombre : '-'}</td><td style="color:${color}; font-weight:bold;">${fmtMoney(Math.abs(m.monto))}</td>`; tbody.appendChild(tr); }); }
    const element = document.getElementById('reporte-imprimible'); element.style.display = 'block'; html2pdf().from(element).set({ margin: 10, filename: `Reporte_${new Date().toISOString().slice(0,10)}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }).save().then(() => { element.style.display = 'none'; });
}
function abrirModalProyecto(id=null) { $('proyecto-overlay').style.display='flex'; $('proyIdEdit').value=id||''; $('checklistCuentasProy').innerHTML=DATA.cuentas.map(c=>`<div style="display:flex;align-items:center;gap:10px;"><input type="checkbox" class="chk-cta-proy" value="${c._id}" id="chk_cta_${c._id}"><label for="chk_cta_${c._id}" style="color:#fff;cursor:pointer;">${c.nombre}</label></div>`).join(''); if(id){const p=DATA.activos.find(a=>a._id===id);$('proyModalTitle').innerText="Editar";$('proyNombre').value=p.nombre;if(p.cuentas_asociadas)p.cuentas_asociadas.forEach(c=>{const k=document.getElementById(`chk_cta_${c._id}`);if(k)k.checked=true;});}else{$('proyModalTitle').innerText="Nuevo";$('proyNombre').value='';} }
async function guardarActivoFull(){const id=$('proyIdEdit').value;const n=$('proyNombre').value;const cs=Array.from(document.querySelectorAll('.chk-cta-proy:checked')).map(c=>c.value);if(!n)return;const u=id?`/api/activos/${id}`:'/api/activos';const m=id?'PUT':'POST';await fetch(u,{method:m,headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n,cuentas:cs})});$('proyecto-overlay').style.display='none';loadData();}
async function borrarActivo(id){if(confirm("Borrar?"))await fetch(`/api/activos/${id}`,{method:'DELETE'});loadData();}
async function crearCuenta(){const n=prompt("Nombre:");if(n)await fetch('/api/cuentas',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})});loadData();}
async function editarCuenta(id,o){const n=prompt("Nombre:",o);if(n)await fetch(`/api/cuentas/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})});loadData();}
async function borrarCuenta(id){if(confirm("Borrar?"))await fetch(`/api/cuentas/${id}`,{method:'DELETE'});loadData();}
async function abrirAdmin(){$('admin-overlay').style.display='flex';cargarUsuariosUI();}
async function cargarUsuariosUI(){
    const r=await fetch('/api/usuarios'); ALL_USERS=await r.json();
    $('checklistProyectos').innerHTML=DATA.activos.map(a=>`<div style="display:flex;align-items:center;gap:5px;"><input type="checkbox" class="chk-proy" value="${a._id}" id="chk_user_proy_${a._id}"><span style="font-size:12px;color:#ccc;">${a.nombre}</span></div>`).join('');
    $('listaUsuarios').innerHTML=ALL_USERS.map(x=> {
        // Mostrar visualmente qu√© cuentas tiene acceso el usuario
        const cuentasAcceso = x.proyectos_permitidos.flatMap(p => p.cuentas_asociadas ? p.cuentas_asociadas.map(c=>c.nombre) : []).join(', ');
        return `
        <li style="display:flex;justify-content:space-between;align-items:center;padding:15px;background:#1a1a1a;margin-bottom:5px;border-radius:8px;">
            <div>
                <strong style="color:${x.es_admin?'var(--green)':'#fff'}">${x.nombre_completo}</strong>
                <div style="font-size:11px;color:#666;">${x.user}</div>
                <div style="font-size:10px;color:var(--yellow);margin-top:2px;">Acceso a: ${cuentasAcceso || 'Ninguna cuenta'}</div>
            </div>
            <div>
                <button class="btn btn-blue btn-small" onclick="editarUsuario('${x._id}')">‚úèÔ∏è</button>
                ${!x.es_admin?`<button class="btn btn-red btn-small" onclick="borrarUsuario('${x._id}')">üóëÔ∏è</button>`:''}
            </div>
        </li>`
    }).join('');
}
function editarUsuario(id){
    const u = ALL_USERS.find(x => x._id === id); if(!u) return;
    $('userIdEdit').value = id; $('userModalTitle').innerText = "EDITAR USUARIO: " + u.user; $('new_fullname').value = u.nombre_completo; $('new_user').value = u.user; $('new_pass').value = '';
    const checkboxes = document.querySelectorAll('.chk-proy'); checkboxes.forEach(c => c.checked = false);
    if(u.proyectos_permitidos) { u.proyectos_permitidos.forEach(p => { const chk = document.getElementById(`chk_user_proy_${p._id}`); if(chk) chk.checked = true; }); }
}
async function guardarUsuario(){
    const id=$('userIdEdit').value; const f=$('new_fullname').value; const u=$('new_user').value; const p=$('new_pass').value; const ps=Array.from(document.querySelectorAll('.chk-proy:checked')).map(c=>c.value);
    if(!u) return alert("Usuario obligatorio"); const url = id ? `/api/usuarios/${id}` : '/api/usuarios'; const method = id ? 'PUT' : 'POST';
    await fetch(url, {method, headers:{'Content-Type':'application/json'}, body:JSON.stringify({user:u, pass:p, nombre_completo:f, proyectos:ps})});
    $('userIdEdit').value=''; $('userModalTitle').innerText="NUEVO COLABORADOR"; $('new_fullname').value=''; $('new_user').value=''; $('new_pass').value=''; cargarUsuariosUI();
}
async function borrarUsuario(id){if(confirm("Eliminar?"))await fetch(`/api/usuarios/${id}`,{method:'DELETE'});cargarUsuariosUI();}
async function guardarMovimiento(){const d=$('desc').value,m=parseFloat($('monto').value),c=$('selCuenta').value,a=$('selActivo').value,r=$('chkReembolso').checked;let s='finalizado';if(currentTipo==='gasto'&&r)s='pendiente_reembolso';if(!d||!m||!c)return;await fetch('/api/movimiento',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({descripcion:d,monto:m,cuenta_id:c,activo_id:a,tipo:currentTipo,estado:s,usuario_actual:CURRENT_USER})});closeModal();loadData();}
async function confirmarReembolso(id){if(!confirm("Lleg√≥?"))return;await fetch('/api/confirmar-reembolso',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mov_id:id,usuario_actual:CURRENT_USER})});loadData();}
const fmtMoney=n=>new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(n);
function openModal(t){currentTipo=t;$('modal').style.display='flex';$('tipoTxt').value=t.toUpperCase();$('desc').value='';$('monto').value='';if(t==='gasto')$('divReembolso').style.display='flex';else $('divReembolso').style.display='none';$('chkReembolso').checked=false;}
function closeModal(){$('modal').style.display='none';}
function populateSelects(){$('selCuenta').innerHTML=DATA.cuentas.map(c=>`<option value="${c._id}">${c.nombre} ($${c.saldo})</option>`).join('');$('selActivo').innerHTML=(IS_ADMIN?`<option value="">-- Personal --</option>`:'')+DATA.activos.map(a=>`<option value="${a._id}">${a.nombre}</option>`).join('');}
function updateChart(){const ctx=$('chartActivos').getContext('2d');if(chartRef)chartRef.destroy();const ac=DATA.activos.filter(a=>a.balance_total>0);chartRef=new Chart(ctx,{type:'doughnut',data:{labels:ac.map(a=>a.nombre),datasets:[{data:ac.map(a=>a.balance_total),borderWidth:0,backgroundColor:['#22c55e','#3b82f6','#ef4444','#eab308']}]},options:{responsive:true,plugins:{legend:{position:'right',labels:{color:'#fff',boxWidth:10}}}}});}
</script>
</body>
</html>
