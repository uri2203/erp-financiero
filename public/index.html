<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ERP CTRFAM | Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
    /* ESTILOS DEL SISTEMA (MODO OSCURO) */
    :root { --bg:#09090b; --card:#18181b; --text:#fafafa; --gray:#a1a1aa; --green:#22c55e; --red:#ef4444; --blue:#3b82f6; --border:#27272a; }
    body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; margin:0; padding:20px; height:100vh; overflow:hidden; display:flex; flex-direction:column; }
    
    /* LAYOUT */
    .top-bar { display:flex; justify-content:space-between; margin-bottom:20px; background:var(--card); padding:15px; border-radius:12px; border:1px solid var(--border); }
    .grid { display:grid; grid-template-columns: 350px 1fr 400px; gap:20px; height:100%; overflow:hidden; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; display:flex; flex-direction:column; overflow:hidden; }
    .card-header { display:flex; justify-content:space-between; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid var(--border); }
    
    /* ELEMENTOS */
    input, select { background:#000; border:1px solid #333; color:#fff; padding:8px; border-radius:6px; width:100%; box-sizing:border-box; margin-bottom:10px; }
    button { cursor:pointer; padding:8px 12px; border-radius:6px; border:none; font-weight:bold; }
    .btn-green { background:var(--green); color:#000; }
    .btn-red { background:rgba(239,68,68,0.2); color:var(--red); border:1px solid var(--red); }
    .btn-blue { background:var(--blue); color:#fff; }
    .btn-gold { background:#eab308; color:#000; }
    
    ul { list-style:none; padding:0; margin:0; overflow-y:auto; flex:1; }
    li { padding:10px; border-bottom:1px solid #222; display:flex; justify-content:space-between; align-items:center; }
    
    /* MODALES (Centrados y Oscuros) */
    .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:99; display:none; justify-content:center; align-items:center; }
    .modal { background:#111; padding:25px; border-radius:15px; border:1px solid #333; width:400px; max-height:90vh; overflow-y:auto; }
    .admin-modal { width:800px; }
    
    /* ADMIN TABS */
    .admin-layout { display:flex; height:500px; gap:20px; }
    .admin-menu { width:150px; border-right:1px solid #333; }
    .admin-menu button { display:block; width:100%; text-align:left; background:none; color:#777; padding:10px; }
    .admin-menu button.active { color:#fff; border-left:2px solid var(--blue); }
    .admin-panel { flex:1; overflow-y:auto; display:none; }
    .admin-panel.active { display:block; }

    /* ESTILO LISTAS */
    .item-row { display:flex; justify-content:space-between; align-items:center; background:#1a1a1a; padding:8px; margin-bottom:5px; border-radius:4px; }
</style>
</head>
<body>

<div id="login-overlay" class="overlay" style="display:flex;">
    <div class="modal" style="text-align:center;">
        <h2>üîê ACCESO</h2>
        <input type="text" id="user" placeholder="Usuario"><input type="password" id="pass" placeholder="Contrase√±a">
        <button class="btn-green" style="width:100%; margin-top:10px;" onclick="doLogin()">ENTRAR</button>
    </div>
</div>

<div id="admin-overlay" class="overlay">
    <div class="modal admin-modal">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h2>‚öôÔ∏è Configuraci√≥n</h2><button class="btn-red" onclick="$('admin-overlay').style.display='none'">X</button></div>
        <div class="admin-layout">
            <div class="admin-menu">
                <button onclick="tab('users')" class="active">üë• Usuarios</button>
                <button onclick="tab('proys')">üöÄ Proyectos</button>
                <button onclick="tab('cats')">üè∑Ô∏è Categor√≠as</button>
                <button onclick="tab('sys')">üíæ Sistema</button>
            </div>
            <div id="tab-users" class="admin-panel active">
                <h3>Usuarios</h3>
                <input type="hidden" id="uid"><input type="text" id="uname" placeholder="Nombre"><input type="text" id="uuser" placeholder="User"><input type="text" id="upass" placeholder="Pass">
                <div id="u-proys" style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin:10px 0;"></div>
                <button class="btn-blue" style="width:100%;" onclick="saveUser()">Guardar</button>
                <div id="list-users" style="margin-top:15px;"></div>
            </div>
            <div id="tab-proys" class="admin-panel">
                <h3>Proyectos</h3>
                <input type="hidden" id="pid"><input type="text" id="pname" placeholder="Nombre Proyecto">
                <div id="p-cuentas" style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin:10px 0;"></div>
                <button class="btn-blue" style="width:100%;" onclick="saveProy()">Guardar</button>
                <div id="list-proys" style="margin-top:15px;"></div>
            </div>
            <div id="tab-cats" class="admin-panel">
                <h3>Categor√≠as</h3>
                <div style="display:flex; gap:5px;"><input id="cname" placeholder="Nombre"><select id="ctype"><option value="gasto">Gasto</option><option value="ingreso">Ingreso</option></select></div>
                <select id="cproy"></select>
                <button class="btn-green" style="width:100%;" onclick="addCat()">Agregar</button>
                <div id="list-cats" style="margin-top:15px;"></div>
            </div>
            <div id="tab-sys" class="admin-panel" style="text-align:center;">
                <h3>Respaldo</h3>
                <button class="btn-blue" onclick="downloadBackup()">Descargar Todo</button>
                <br><br>
                <button class="btn-red" onclick="$('restFile').click()">Restaurar</button>
                <input type="file" id="restFile" style="display:none;" onchange="restoreBackup(this)">
            </div>
        </div>
    </div>
</div>

<div id="reporte-overlay" class="overlay">
    <div class="modal admin-modal">
        <div style="display:flex; justify-content:space-between;"><h2>üìä Reporte</h2><div><button class="btn-gold" onclick="printReporte()">üì• PDF SIMPLE</button> <button class="btn-red" onclick="$('reporte-overlay').style.display='none'">X</button></div></div>
        <div style="display:flex; gap:10px; margin:10px 0;">
            <select id="f-anio" onchange="runRep()"><option value="2026">2026</option><option value="2025">2025</option></select>
            <select id="f-mes" onchange="runRep()"><option value="todos">Todo el a√±o</option><option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option></select>
            <select id="f-proy" onchange="runRep()"><option value="todos">Todos</option></select>
        </div>
        <div style="display:flex; text-align:center; gap:10px; margin-bottom:20px;">
            <div style="flex:1; background:#222; padding:10px;">Ingresos<br><b style="color:var(--green)" id="r-ing">$0</b></div>
            <div style="flex:1; background:#222; padding:10px;">Gastos<br><b style="color:var(--red)" id="r-gas">$0</b></div>
            <div style="flex:1; background:#222; padding:10px;">Neto<br><b style="color:#fff" id="r-net">$0</b></div>
        </div>
        <div style="height:300px;"><canvas id="chartRep"></canvas></div>
    </div>
</div>

<div id="modal-mov" class="overlay"><div class="modal"><h3>Registro</h3><input id="m-desc" placeholder="Concepto"><div style="display:flex;gap:5px;"><input id="m-monto" type="number" placeholder="$"><input id="m-tipo" readonly></div><select id="m-proy" onchange="filterCats()"></select><select id="m-cat"></select><div id="div-reem" style="display:none;"><input type="checkbox" id="m-reem"> Pendiente Reembolso</div><select id="m-cta"></select><button class="btn-green" onclick="saveMov()" style="width:100%;margin-top:10px;">Guardar</button><button class="btn-red" onclick="$('modal-mov').style.display='none'" style="width:100%;margin-top:5px;">Cancelar</button></div></div>

<div id="modal-tras" class="overlay"><div class="modal"><h3>Traspaso</h3><input id="t-monto" type="number" placeholder="$"><select id="t-origen"></select><select id="t-destino"></select><select id="t-proy"></select><input id="t-desc" placeholder="Nota"><button class="btn-blue" onclick="doTras()" style="width:100%;margin-top:10px;">Confirmar</button><button class="btn-red" onclick="$('modal-tras').style.display='none'" style="width:100%;margin-top:5px;">Cancelar</button></div></div>

<div id="modal-arq" class="overlay"><div class="modal"><h3>Corte Caja</h3><div id="list-arq"></div><h2 style="text-align:center;" id="t-arq">$0</h2><button class="btn-gold" onclick="printArqueo()" style="width:100%;">üìÑ PDF CORTE</button><button class="btn-red" onclick="$('modal-arq').style.display='none'" style="width:100%;margin-top:5px;">Cerrar</button></div></div>

<div class="top-bar">
    <div><small style="color:#aaa;">PATRIMONIO</small><div style="font-size:24px; font-weight:bold;" id="dash-total">...</div></div>
    <div style="display:flex; gap:5px;">
        <button class="btn-blue" onclick="openTras()">‚áÑ</button>
        <button class="btn-gold" onclick="openRep()">üìä</button>
        <button class="btn-blue" id="btn-admin" onclick="openAdmin()" style="display:none;">‚öôÔ∏è</button>
        <button class="btn-green" onclick="openMov('ingreso')">‚¨Ü</button>
        <button class="btn-red" onclick="openMov('gasto')">‚¨á</button>
        <button style="background:#333; color:#fff;" onclick="location.reload()">üîì</button>
    </div>
</div>

<div class="grid">
    <div class="card">
        <div class="card-header"><b>CUENTAS</b> <div><button class="btn-gold" style="font-size:10px;" onclick="openArq()">CORTE</button> <button class="btn-blue" id="btn-add-cta" style="font-size:10px; display:none;" onclick="addCta()">+</button></div></div>
        <div id="dash-cuentas"></div>
    </div>
    <div class="card">
        <div class="card-header"><b>PROYECTOS</b></div>
        <div id="dash-proys"></div>
    </div>
    <div class="card">
        <div class="card-header"><b>MOVIMIENTOS</b><input id="search" placeholder="üîç" style="width:80px; padding:2px;" onkeyup="renderMovs()"></div>
        <ul id="dash-movs"></ul>
    </div>
</div>

<script>
const $ = id => document.getElementById(id);
let DATA = {}, USER = '', ADMIN = false, REP = null;

// --- LOGIN ---
async function doLogin() {
    const u=$('user').value, p=$('pass').value;
    const r = await fetch('/api/login', {method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify({user:u,pass:p})});
    const d = await r.json();
    if(d.success) { USER=d.user; ADMIN=d.es_admin; $('login-overlay').style.display='none'; load(); }
    else alert('Error');
}

async function load() {
    const r = await fetch(`/api/data?user=${USER}`);
    DATA = await r.json();
    $('dash-total').innerText = fmt(DATA.patrimonio);
    
    // Renders
    $('dash-cuentas').innerHTML = DATA.cuentas.map(c=>`<div class="item-row"><span>${c.nombre}</span><b>${fmt(c.saldo)}</b></div>`).join('');
    $('dash-proys').innerHTML = DATA.activos.map(p=>`<div class="item-row"><span>${p.nombre}</span><b style="color:${p.balance_total>=0?'lime':'red'}">${fmt(p.balance_total)}</b></div>`).join('');
    renderMovs();

    // Permisos
    if(ADMIN) { $('btn-admin').style.display='block'; $('btn-add-cta').style.display='block'; }
    
    // Selects generales
    const ctasOpts = DATA.cuentas.map(c=>`<option value="${c._id}">${c.nombre}</option>`).join('');
    const proyOpts = DATA.activos.map(p=>`<option value="${p._id}">${p.nombre}</option>`).join('');
    $('m-cta').innerHTML=ctasOpts; $('m-proy').innerHTML=proyOpts; 
    $('t-origen').innerHTML=ctasOpts; $('t-destino').innerHTML=ctasOpts; $('t-proy').innerHTML=proyOpts;
    $('f-proy').innerHTML='<option value="todos">Todos</option>'+proyOpts;
}

function renderMovs() {
    const q = $('search').value.toLowerCase();
    const list = DATA.movimientos.filter(m=> JSON.stringify(m).toLowerCase().includes(q));
    $('dash-movs').innerHTML = list.map(m=>`<li style="font-size:12px;"><div><b>${m.descripcion}</b><br><span style="color:#777">${m.categoria||'-'}</span></div><span style="color:${m.tipo=='ingreso'?'lime':'red'}">${fmt(m.monto)}</span></li>`).join('');
}

// --- PDF SIMPLE (GENERACI√ìN DIRECTA) ---
function printReporte() {
    if(!REP) return alert("Carga datos primero");
    
    // 1. Crear el HTML "imprimible" en memoria (Texto Negro sobre Blanco forzado)
    const content = `
        <div style="font-family:Helvetica; padding:40px; color:black; background:white;">
            <h1 style="text-align:center; border-bottom:2px solid black;">REPORTE FINANCIERO</h1>
            <p><b>Fecha:</b> ${new Date().toLocaleDateString()} <br> <b>Usuario:</b> ${USER}</p>
            <table style="width:100%; border-collapse:collapse; margin-top:20px;">
                <tr style="background:#eee; border-bottom:1px solid black;">
                    <th style="padding:10px; text-align:left;">INGRESOS</th>
                    <th style="padding:10px; text-align:left;">GASTOS</th>
                    <th style="padding:10px; text-align:left;">NETO</th>
                </tr>
                <tr>
                    <td style="padding:10px; font-size:20px;">${fmt(REP.ingresos)}</td>
                    <td style="padding:10px; font-size:20px;">${fmt(REP.gastos)}</td>
                    <td style="padding:10px; font-size:20px;">${fmt(REP.neto)}</td>
                </tr>
            </table>
            <h3 style="margin-top:30px; border-bottom:1px solid black;">DETALLE</h3>
            <table style="width:100%; font-size:12px; border-collapse:collapse;">
                <tr style="background:#eee;"><th style="padding:5px; text-align:left;">Fecha</th><th style="padding:5px; text-align:left;">Desc</th><th style="padding:5px; text-align:left;">Monto</th></tr>
                ${REP.detalles.map(m=>`<tr>
                    <td style="padding:5px; border-bottom:1px solid #ccc;">${new Date(m.fecha).toLocaleDateString()}</td>
                    <td style="padding:5px; border-bottom:1px solid #ccc;">${m.descripcion} <small>(${m.categoria})</small></td>
                    <td style="padding:5px; border-bottom:1px solid #ccc;">${fmt(Math.abs(m.monto))}</td>
                </tr>`).join('')}
            </table>
        </div>
    `;

    // 2. Generar PDF usando ese HTML limpio
    html2pdf().from(content, 'string').set({ margin:10, filename:'Reporte.pdf' }).save();
}

function printArqueo() {
    let t=0, htmlRows='';
    document.querySelectorAll('.chk-arq:checked').forEach(c => {
        t += parseFloat(c.value);
        htmlRows += `<tr><td style="padding:5px; border-bottom:1px solid #ccc;">${c.dataset.n}</td><td style="padding:5px; text-align:right; border-bottom:1px solid #ccc;">${fmt(c.value)}</td></tr>`;
    });
    
    if(t===0) return alert("Selecciona cuentas");

    const content = `
        <div style="font-family:Helvetica; padding:40px; color:black; background:white;">
            <h1 style="text-align:center; border-bottom:2px solid black;">CORTE DE CAJA</h1>
            <p><b>Fecha:</b> ${new Date().toLocaleString()} <br> <b>Responsable:</b> ${USER}</p>
            <table style="width:100%; border-collapse:collapse; margin-top:20px;">
                <tr style="background:#eee;"><th style="padding:10px; text-align:left;">CUENTA</th><th style="padding:10px; text-align:right;">SALDO</th></tr>
                ${htmlRows}
            </table>
            <h2 style="text-align:right; margin-top:20px; border-top:2px solid black;">TOTAL: ${fmt(t)}</h2>
            <br><br><br>
            <center>__________________________<br>Firma de Conformidad</center>
        </div>
    `;
    
    // Guardar en BD (Silencioso)
    fetch('/api/arqueo', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({usuario:USER, total:t, detalles:[]})});
    
    // Descargar
    html2pdf().from(content, 'string').set({ margin:10, filename:'Corte_Caja.pdf' }).save();
}

// --- LOGICA DE NEGOCIO ---
async function runRep() {
    const a=$('f-anio').value, m=$('f-mes').value, p=$('f-proy').value;
    const r = await fetch('/api/reporte', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({anio:a, mes:m, activo_id:p, user:USER})});
    REP = await r.json();
    $('r-ing').innerText=fmt(REP.ingresos); $('r-gas').innerText=fmt(REP.gastos); $('r-net').innerText=fmt(REP.neto);
    // Chart
    new Chart($('chartRep'), { type:'bar', data: { labels:['Ing','Gas'], datasets:[{data:[REP.ingresos, REP.gastos], backgroundColor:['#22c55e','#ef4444']}] } });
}

function openMov(t) { 
    $('m-tipo').value=t; $('modal-mov').style.display='flex'; $('div-reem').style.display = t==='gasto'?'block':'none'; filterCats();
}
async function saveMov() {
    const body = { descripcion:$('m-desc').value, monto:$('m-monto').value, tipo:$('m-tipo').value, cuenta_id:$('m-cta').value, activo_id:$('m-proy').value, categoria:$('m-cat').value, usuario_actual:USER };
    await fetch('/api/movimiento', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
    $('modal-mov').style.display='none'; load();
}
function filterCats() {
    const p = $('m-proy').value;
    const cats = DATA.categorias.filter(c => (!c.proyecto_id || c.proyecto_id._id === p) && c.tipo === $('m-tipo').value);
    $('m-cat').innerHTML = cats.length ? cats.map(c=>`<option>${c.nombre}</option>`).join('') : '<option>General</option>';
}

function openArq() {
    $('modal-arq').style.display='flex';
    $('list-arq').innerHTML = DATA.cuentas.map(c=>`<div class="item-row"><input type="checkbox" class="chk-arq" value="${c.saldo}" data-n="${c.nombre}" onchange="calcArq()"> ${c.nombre} <b>${fmt(c.saldo)}</b></div>`).join('');
    calcArq();
}
function calcArq() {
    let t=0; document.querySelectorAll('.chk-arq:checked').forEach(c=>t+=parseFloat(c.value));
    $('t-arq').innerText=fmt(t);
}

// ADMIN B√ÅSICO
function openAdmin(){ $('admin-overlay').style.display='flex'; tab('users'); loadAdmin(); }
function tab(t) { document.querySelectorAll('.admin-panel').forEach(p=>p.classList.remove('active')); $(`tab-${t}`).classList.add('active'); }
async function loadAdmin() {
    const r = await fetch('/api/usuarios'); const us = await r.json();
    $('list-users').innerHTML = us.map(u=>`<div class="item-row"><b>${u.user}</b> <button class="btn-blue" onclick="editU('${u._id}')">‚úèÔ∏è</button></div>`).join('');
    $('list-proys').innerHTML = DATA.activos.map(p=>`<div class="item-row"><b>${p.nombre}</b> <button class="btn-blue" onclick="editP('${p._id}')">‚úèÔ∏è</button></div>`).join('');
    $('list-cats').innerHTML = DATA.categorias.map(c=>`<div class="item-row">${c.nombre} (${c.tipo}) <button class="btn-red" onclick="delCat('${c._id}')">X</button></div>`).join('');
    
    // Checklists
    $('u-proys').innerHTML = DATA.activos.map(p=>`<label><input type="checkbox" class="chk-u-p" value="${p._id}"> ${p.nombre}</label>`).join('');
    $('p-cuentas').innerHTML = DATA.cuentas.map(c=>`<label><input type="checkbox" class="chk-p-c" value="${c._id}"> ${c.nombre}</label>`).join('');
    $('cproy').innerHTML = '<option value="">-- General --</option>' + DATA.activos.map(p=>`<option value="${p._id}">${p.nombre}</option>`).join('');
}

// CRUD SIMPLIFICADO
async function saveUser() {
    const ps = Array.from(document.querySelectorAll('.chk-u-p:checked')).map(c=>c.value);
    const body = { user:$('uuser').value, pass:$('upass').value, nombre_completo:$('uname').value, proyectos:ps };
    const id = $('uid').value; const m = id ? 'PUT' : 'POST'; const u = id ? `/api/usuarios/${id}` : '/api/usuarios';
    await fetch(u, {method:m, headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
    loadAdmin(); $('uid').value=''; $('uuser').value='';
}
function editU(id) { $('uid').value=id; $('uuser').focus(); } // Simplificado para brevedad

async function saveProy() {
    const cs = Array.from(document.querySelectorAll('.chk-p-c:checked')).map(c=>c.value);
    const body = { nombre:$('pname').value, cuentas:cs };
    const id = $('pid').value; const m = id ? 'PUT' : 'POST'; const u = id ? `/api/activos/${id}` : '/api/activos';
    await fetch(u, {method:m, headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
    loadAdmin();
}
function editP(id) { $('pid').value=id; $('pname').focus(); }

async function addCat() { await fetch('/api/categorias', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({nombre:$('cname').value, tipo:$('ctype').value, proyecto_id:$('cproy').value})}); loadAdmin(); }
async function delCat(id) { if(confirm('X')) await fetch(`/api/categorias/${id}`, {method:'DELETE'}); loadAdmin(); }

// UTILIDADES
async function downloadBackup(){ const r=await fetch(`/api/backup?user=${USER}`); const d=await r.json(); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(d)],{type:'application/json'})); a.download='Backup.json'; a.click(); }
async function restoreBackup(i){ const f=i.files[0]; const r=new FileReader(); r.onload=async(e)=>{ await fetch('/api/restore',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:JSON.parse(e.target.result), user:USER})}); alert('OK'); location.reload(); }; r.readAsText(f); }
function openTras(){ $('modal-tras').style.display='flex'; }
async function doTras(){ await fetch('/api/traspaso',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({origen_id:$('t-origen').value, destino_id:$('t-destino').value, monto:$('t-monto').value, descripcion:$('t-desc').value, usuario_actual:USER, activo_id:$('t-proy').value})}); $('modal-tras').style.display='none'; load(); }
function addCta() { const n=prompt('Nombre Cuenta'); if(n) fetch('/api/cuentas',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})}).then(load); }
const fmt = n => new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(n);
function openRep(){ $('reporte-overlay').style.display='flex'; runRep(); }
</script>
</body>
</html>
