<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ERP CTRFAM | V33 Aligned</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* --- DISE√ëO ELITE DARK --- */
    :root { 
        --bg:#050505; --card:#111; --sidebar:#080808;
        --text:#e0e0e0; --muted:#666;
        --green:#22c55e; --red:#ef4444; --blue:#3b82f6; --gold:#eab308; --purple:#a855f7; --cyan:#06b6d4; --orange:#f97316;
        --border:#222;
    }
    body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; margin:0; padding:20px; height:100vh; box-sizing:border-box; display:flex; flex-direction:column; overflow:hidden; }
    
    /* MODALS */
    .overlay { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.95); backdrop-filter:blur(5px); z-index:9999; display:none; justify-content:center; align-items:center; }
    .box-sm { width:400px; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:30px; box-shadow:0 20px 50px rgba(0,0,0,0.8); display:flex; flex-direction:column; }
    .box-lg { width:95%; max-width:1100px; height:90vh; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px; display:flex; flex-direction:column; box-shadow:0 30px 60px rgba(0,0,0,0.9); }

    /* ADMIN */
    .admin-container { display:flex; height:100%; gap:20px; }
    .admin-sidebar { width:220px; background:var(--sidebar); border-right:1px solid var(--border); padding:10px; display:flex; flex-direction:column; gap:5px; border-radius:12px; }
    .admin-content { flex:1; padding:20px; overflow-y:auto; background:#0c0c0c; border-radius:12px; border:1px solid var(--border); }
    
    .tab-btn { background:transparent; border:none; color:var(--muted); padding:12px 15px; text-align:left; cursor:pointer; border-radius:8px; font-weight:600; width:100%; transition:0.2s; font-size:13px; }
    .tab-btn:hover { background:rgba(255,255,255,0.05); color:#fff; }
    .tab-btn.active { background:rgba(59, 130, 246, 0.1); color:var(--blue); border-left:3px solid var(--blue); }
    .tab-section { display:none; animation:fadeIn 0.3s; }
    .tab-section.active { display:block; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

    /* CHECKLIST ALINEADO (NUEVO) */
    .checklist-box {
        display: grid;
        grid-template-columns: 1fr 1fr; /* Dos columnas limpias */
        gap: 10px;
        background: #000;
        padding: 15px;
        border: 1px solid #333;
        border-radius: 8px;
        max-height: 150px;
        overflow-y: auto;
        text-align: left; /* Forzar alineaci√≥n izquierda */
    }
    .check-item {
        display: flex;
        align-items: center;
        gap: 10px; /* Espacio entre cuadrito y texto */
        font-size: 13px;
        color: #ccc;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
        transition: 0.2s;
    }
    .check-item:hover { background: rgba(255,255,255,0.1); }
    .check-item input { 
        margin: 0; 
        width: 16px; 
        height: 16px; 
        cursor: pointer; 
        accent-color: var(--blue); /* Color del check */
    }

    /* DASHBOARD */
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:var(--card); padding:15px 25px; border-radius:16px; border:1px solid var(--border); box-shadow:0 4px 10px rgba(0,0,0,0.5); }
    .grid { display:grid; grid-template-columns: 350px 1fr 380px; gap:20px; height:100%; overflow:hidden; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 10px 20px -5px rgba(0,0,0,0.5); }
    .card-header { display:flex; justify-content:space-between; align-items:center; padding-bottom:15px; border-bottom:1px solid var(--border); margin-bottom:15px; }
    
    h2 { font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:1.5px; margin:0; font-weight:700; }
    .big-number { font-size:28px; font-weight:800; color:#fff; letter-spacing:-0.5px; }
    
    input, select { width:100%; padding:12px; background:#000; border:1px solid #333; color:#fff; border-radius:8px; margin-bottom:10px; box-sizing:border-box; outline:none; transition:0.3s; font-family:'Inter',sans-serif; font-size:13px; }
    input:focus, select:focus { border-color:var(--blue); box-shadow:0 0 0 2px rgba(59,130,246,0.2); }
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

    .btn { border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600; font-size:11px; display:flex; align-items:center; gap:8px; color:white; text-transform:uppercase; letter-spacing:0.5px; justify-content:center; transition:0.2s; }
    .btn:hover { transform:translateY(-1px); filter:brightness(1.2); }
    
    /* MICRO BOTONES */
    .btn-icon { width: 32px; height: 32px; padding: 0; border-radius: 6px; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px solid transparent; transition: 0.2s; background: rgba(255,255,255,0.05); color: #fff; }
    .btn-icon:hover { transform: scale(1.05); }
    .btn-icon.edit:hover { background: rgba(59, 130, 246, 0.2); border-color: var(--blue); color: var(--blue); }
    .btn-icon.del:hover { background: rgba(239, 68, 68, 0.2); border-color: var(--red); color: var(--red); }

    .bg-green { background:linear-gradient(135deg, #16a34a, #22c55e); color:#000; } 
    .bg-red { background:rgba(239,68,68,0.1); border:1px solid var(--red); color:var(--red); }
    .bg-blue { background:linear-gradient(135deg, #2563eb, #3b82f6); }
    .bg-gold { background:var(--gold); color:#000; }
    .bg-purple { background:var(--purple); color:#fff; }
    .bg-cyan { background:var(--cyan); color:#000; }
    .bg-orange { background:var(--orange); color:#000; }

    .item-list { overflow-y:auto; flex:1; padding-right:5px; }
    .item-row { display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #1a1a1a; transition:0.2s; border-radius:6px; margin-bottom:2px; }
    .item-row:hover { background:rgba(255,255,255,0.03); }
    .flex-row { display:flex; gap:10px; }
    
    /* DEUDAS */
    .progress-track { width: 100%; background: #222; height: 6px; border-radius: 3px; margin-top: 8px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--blue); transition: width 0.5s ease; }
    
    /* IMPRESION PRO */
    #print-area { display:none; }
    @media print {
        body * { visibility: hidden; }
        #print-area, #print-area * { visibility: visible; }
        #print-area { display: block !important; position: absolute; left: 0; top: 0; width: 100%; background: white; color: black; font-family: 'Helvetica', sans-serif; padding: 30px; box-sizing: border-box; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .print-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 20px; }
        .print-logo { font-size: 24px; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; }
        .print-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
        .print-table th { background-color: #000; color: #fff; padding: 8px; text-align: left; text-transform: uppercase; font-weight: bold; }
        .print-table td { border-bottom: 1px solid #ccc; padding: 8px; color: #000; }
        .print-table tr:nth-child(even) { background-color: #f5f5f5; }
        .text-right { text-align: right; }
        .text-red-print { color: #d00 !important; font-weight: bold; }
        .debt-container { margin-bottom: 30px; border: 1px solid #000; padding: 15px; page-break-inside: avoid; }
    }

    @media (max-width: 1200px) { .grid { grid-template-columns:1fr; overflow-y:auto; } body { height:auto; overflow-y:auto; } }
</style>
</head>
<body>

<div id="print-area"></div>

<div id="login-overlay" class="overlay" style="display:flex;">
    <div class="box-sm" style="text-align:center;">
        <h2 style="color:#fff; margin-bottom:30px; letter-spacing:2px;">üîê ACCESO ERP</h2>
        <input type="text" id="user" placeholder="Usuario">
        <input type="password" id="pass" placeholder="Contrase√±a">
        <button class="btn bg-green" style="width:100%; margin-top:20px; height:45px;" onclick="doLogin()">INICIAR SESI√ìN</button>
        <p id="loginError" style="color:var(--red); font-size:12px; display:none; margin-top:15px;">Acceso Denegado</p>
    </div>
</div>

<div id="admin-overlay" class="overlay">
    <div class="box-lg">
        <div class="admin-container">
            <aside class="admin-sidebar">
                <h3 style="color:var(--muted); font-size:10px; padding:10px; letter-spacing:1px;">PANEL CONTROL</h3>
                <button class="tab-btn active" id="btn-tab-personal" onclick="switchTab('personal')">üë• Personal</button>
                <button class="tab-btn" id="btn-tab-proyectos" onclick="switchTab('proyectos')">üöÄ Proyectos</button>
                <button class="tab-btn" id="btn-tab-categorias-admin" onclick="switchTab('categorias-admin')">üè∑Ô∏è Cat√°logo</button>
                <button class="tab-btn" id="btn-tab-sistema" onclick="switchTab('sistema')">üíæ Sistema</button>
                <div style="flex:1;"></div>
                <button class="btn bg-red" style="width:100%;" onclick="document.getElementById('admin-overlay').style.display='none'">CERRAR PANEL</button>
            </aside>
            <main class="admin-content">
                <div id="tab-personal" class="tab-section active">
                    <h2 style="color:#fff; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:20px;">Gesti√≥n de Usuarios</h2>
                    <div class="admin-form-group">
                        <h3 style="margin:0 0 10px 0; font-size:12px; color:var(--blue);" id="userTitle">NUEVO EMPLEADO</h3>
                        <input type="hidden" id="userIdEdit">
                        <div style="display:flex;gap:10px;"><input type="text" id="new_fullname" placeholder="Nombre Completo"><input type="text" id="new_user" placeholder="Usuario"></div>
                        <input type="text" id="new_pass" placeholder="Contrase√±a">
                        
                        <label style="font-size:11px;color:var(--muted); display:block; margin-bottom:5px;">Acceso a Proyectos:</label>
                        <div id="checklistProyectos" class="checklist-box"></div>
                        
                        <button class="btn bg-blue" style="width:100%; margin-top:15px;" onclick="guardarUsuario()">GUARDAR USUARIO</button>
                    </div>
                    <h3 style="font-size:12px; color:#aaa; margin-top:20px;">LISTA DE PERSONAL</h3>
                    <ul id="listaUsuarios" class="admin-list"></ul>
                </div>
                
                <div id="tab-proyectos" class="tab-section">
                    <h2 style="color:#fff; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:20px;">Proyectos</h2>
                    <div class="admin-form-group">
                        <h3 style="margin:0 0 10px 0; font-size:12px; color:var(--blue);" id="proyTitle">NUEVO PROYECTO</h3>
                        <input type="hidden" id="proyIdEdit"><input type="text" id="proyNombre" placeholder="Nombre Proyecto">
                        
                        <label style="font-size:11px;color:var(--gold); display:block; margin-bottom:5px;">Cuentas Vinculadas:</label>
                        <div id="checklistCuentasProy" class="checklist-box"></div>
                        
                        <button class="btn bg-blue" style="width:100%; margin-top:15px;" onclick="guardarActivoFull()">GUARDAR PROYECTO</button>
                    </div>
                    <ul id="listaProyectosAdmin" class="admin-list"></ul>
                </div>
                
                <div id="tab-categorias-admin" class="tab-section">
                    <h2 style="color:#fff; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:20px;">Cat√°logo Global</h2>
                    <div class="admin-form-group">
                        <div style="display:flex;gap:10px;"><input type="text" id="newCatName" placeholder="Nueva Categor√≠a"><select id="newCatType"><option value="gasto">Gasto</option><option value="ingreso">Ingreso</option></select></div>
                        <select id="newCatProy"></select><button class="btn bg-green" style="width:100%; margin-top:10px;" onclick="crearCat()">AGREGAR</button>
                    </div>
                    <select id="catFilterProy" onchange="renderCatsAdmin()" style="width:200px;"><option value="all">Ver Todos</option></select>
                    <ul id="listaCatsAdmin" class="admin-list" style="max-height:400px;"></ul>
                </div>
                <div id="tab-sistema" class="tab-section">
                    <h2 style="color:#fff; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:20px;">Datos</h2>
                    <div style="text-align:center; padding:40px;">
                        <button class="btn bg-blue" style="margin:0 auto;" onclick="descargarBackup()">üíæ RESPALDAR</button><br><br>
                        <button class="btn bg-red" style="margin:0 auto;" onclick="$('restoreInput').click()">‚ôªÔ∏è RESTAURAR</button>
                        <input type="file" id="restoreInput" style="display:none;" onchange="restaurarBackup(this)">
                    </div>
                </div>
            </main>
        </div>
    </div>
</div>

<div id="reporte-overlay" class="overlay">
    <div class="box-lg">
        <div style="display:flex;justify-content:space-between;margin-bottom:20px;">
            <h2>üìä Reporte Financiero</h2>
            <div style="display:flex;gap:10px;">
                <button class="btn bg-gold" onclick="imprimirReporte()">üñ®Ô∏è PDF</button>
                <button class="btn bg-red" onclick="document.getElementById('reporte-overlay').style.display='none'">X</button>
            </div>
        </div>
        <div style="display:flex;gap:10px;margin-bottom:15px;">
            <select id="filtroAnio" onchange="actualizarReporte()"><option value="2026">2026</option><option value="2025">2025</option></select>
            <select id="filtroMes" onchange="actualizarReporte()"><option value="todos">A√±o</option><option value="0">Ene</option><option value="1">Feb</option><option value="2">Mar</option><option value="3">Abr</option><option value="4">May</option><option value="5">Jun</option><option value="6">Jul</option><option value="7">Ago</option><option value="8">Sep</option><option value="9">Oct</option><option value="10">Nov</option><option value="11">Dic</option></select>
            <select id="filtroProyecto" onchange="actualizarReporte()"><option value="todos">Todos</option></select>
        </div>
        <div style="background:#151515;padding:10px;border-radius:8px;margin-bottom:20px;border:1px solid #333;">
            <label style="font-size:11px;color:var(--muted);margin-bottom:5px;display:block;">Cuentas:</label><div id="report-accounts-list" style="display:flex;gap:15px;flex-wrap:wrap;"></div>
        </div>
        <div style="display:flex;gap:20px;margin-bottom:20px;text-align:center;">
            <div style="flex:1;background:#1a1a1a;padding:15px;border-radius:12px;"><small style="color:#aaa;">ENTRADAS</small><div id="repIng" class="big-number" style="color:var(--green)"></div></div>
            <div style="flex:1;background:#1a1a1a;padding:15px;border-radius:12px;"><small style="color:#aaa;">SALIDAS</small><div id="repGas" class="big-number" style="color:var(--red)"></div></div>
            <div style="flex:1;background:#1a1a1a;padding:15px;border-radius:12px;"><small style="color:#aaa;">NETO</small><div id="repNeto" class="big-number"></div></div>
        </div>
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;flex:1;overflow:hidden;">
            <div style="position:relative;height:100%;"><canvas id="chartReporteMain"></canvas></div>
            <div style="position:relative;height:100%;"><canvas id="chartReporteCat"></canvas></div>
        </div>
    </div>
</div>

<div id="debts-overlay" class="overlay">
    <div class="box-sm">
        <h2 style="margin-bottom:20px;color:var(--orange);">üìâ Pasivos & Deudas</h2>
        <div style="background:#151515; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #333;">
            <label style="font-size:11px;color:var(--muted);">Nueva Deuda</label>
            <div class="flex-row">
                <input id="debtName" placeholder="Concepto (Ej. Laptop)">
                <input id="debtAmount" type="number" placeholder="Total a Pagar">
            </div>
            <button class="btn bg-green" style="width:100%; justify-content:center;" onclick="addDebt()">+ AGREGAR</button>
        </div>
        <div id="debtsList" class="item-list" style="max-height:300px;"></div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn bg-gold" style="flex:1; justify-content:center;" onclick="imprimirReporteDeudas()">üñ®Ô∏è REPORTE</button>
            <button class="btn bg-red" style="width:100px; justify-content:center;" onclick="document.getElementById('debts-overlay').style.display='none'">CERRAR</button>
        </div>
    </div>
</div>

<div id="cats-overlay" class="overlay"><div class="box-sm"><h2 style="margin-bottom:20px;">Mis Categor√≠as</h2><div style="display:flex;gap:10px;"><input id="u-catName" placeholder="Nombre"><select id="u-catType"><option value="gasto">Gasto</option><option value="ingreso">Ingreso</option></select></div><label style="font-size:11px;color:var(--muted);">Asignar:</label><select id="u-catProy"></select><button class="btn bg-green" style="width:100%;margin:10px 0;" onclick="crearCatUser()">AGREGAR</button><div id="u-listaCats" class="item-list" style="max-height:300px;"></div><button class="btn bg-red" style="width:100%;margin-top:10px;" onclick="document.getElementById('cats-overlay').style.display='none'">CERRAR</button></div></div>
<div id="traspaso-overlay" class="overlay"><div class="box-sm"><h2>Traspaso</h2><label style="font-size:11px;color:var(--muted);">Monto</label><input type="number" id="trasMonto"><label style="font-size:11px;color:var(--muted);">Origen</label><select id="trasOrigen"></select><label style="font-size:11px;color:var(--muted);">Destino</label><select id="trasDestino"></select><label style="font-size:11px;color:var(--muted);">Proyecto</label><select id="trasProyecto"></select><label style="font-size:11px;color:var(--muted);">Nota</label><input type="text" id="trasDesc"><div style="display:flex;gap:10px;margin-top:20px;"><button class="btn bg-cyan" style="flex:1;" onclick="ejecutarTraspaso()">CONFIRMAR</button><button class="btn bg-red" style="flex:1;" onclick="document.getElementById('traspaso-overlay').style.display='none'">CANCELAR</button></div></div></div>
<div id="arqueo-overlay" class="overlay"><div class="box-sm"><h2>Corte de Caja</h2><div id="listaArqueo" class="item-list" style="max-height:300px;"></div><h2 style="text-align:center;color:var(--green);margin:20px 0;" id="totalArqueo">$0</h2><button class="btn bg-purple" onclick="imprimirArqueo()" style="width:100%;">üñ®Ô∏è PDF</button><button class="btn bg-red" style="width:100%;margin-top:10px;" onclick="document.getElementById('arqueo-overlay').style.display='none'">CERRAR</button></div></div>
<div id="modal" class="overlay"><div class="box-sm"><h2 style="margin-bottom:20px;">Registro</h2><input type="hidden" id="movIdEdit"><div class="flex-row"><div style="flex:1"><label style="font-size:11px;color:var(--muted);">Fecha</label><input type="date" id="fechaMov"></div><div style="flex:2"><label style="font-size:11px;color:var(--muted);">Concepto <span style="color:var(--red)">*</span></label><input type="text" id="desc"></div></div><div style="display:flex;gap:10px;"><div style="flex:1"><label style="font-size:11px;color:var(--muted);">Monto</label><input type="number" id="monto"></div><div style="flex:1"><label style="font-size:11px;color:var(--muted);">Tipo</label><input type="text" id="tipoTxt" readonly></div></div><div id="createFields"><label style="font-size:11px;color:var(--muted);">Proyecto</label><select id="selActivo" onchange="filtrarCategorias()"></select><label style="font-size:11px;color:var(--muted);">Cuenta</label><select id="selCuenta"></select></div><label style="font-size:11px;color:var(--muted);">Categor√≠a</label><select id="selCat"></select><div id="divReembolso" style="display:none;margin-bottom:15px;background:#222;padding:10px;border-radius:5px;"><input type="checkbox" id="chkReembolso"><label for="chkReembolso" style="color:var(--gold);font-size:12px;">‚ö†Ô∏è Pendiente Reembolso</label></div><button class="btn bg-green" style="width:100%;" onclick="guardarMovimiento()">CONFIRMAR</button><button class="btn bg-red" style="width:100%;margin-top:10px;" onclick="document.getElementById('modal').style.display='none'">CANCELAR</button></div></div>

<div class="top-bar">
    <div><div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;">Patrimonio Total</div><div class="big-number" id="totalPatrimonio">---</div></div>
    <div style="display:flex;gap:10px;">
        <button class="btn bg-orange" id="btnDebts" style="display:none;" onclick="openDebts()">üìâ DEUDAS</button>
        <button class="btn bg-purple" onclick="abrirCatsUser()">üè∑Ô∏è CAT</button>
        <button class="btn bg-cyan" onclick="abrirTraspaso()">‚áÑ TRASPASO</button>
        <button class="btn bg-gold" id="btnReportes" style="display:none;" onclick="abrirReportes()">üìä REPORTES</button>
        <button class="btn bg-blue" id="btnAdmin" style="display:none;" onclick="abrirAdmin()">‚öôÔ∏è ADMIN</button>
        <button class="btn bg-green" onclick="openModal('ingreso')">‚¨Ü INGRESAR</button>
        <button class="btn bg-red" onclick="openModal('gasto')">‚¨á GASTAR</button>
        <button class="btn" style="background:#222;color:#fff;" onclick="logout()">üîì</button>
    </div>
</div>
<div id="radar-alertas" style="display:none; flex-direction:column; gap:10px; margin-bottom:20px;"></div>
<div class="grid">
    <div class="card"><div class="card-header"><h2>üè¶ Cuentas</h2><div style="display:flex;gap:5px;"><button class="btn bg-purple btn-small" style="font-size:10px;" onclick="abrirArqueo()">CORTE</button><button class="btn bg-blue btn-small" id="btnAddCta" style="font-size:10px;display:none;" onclick="crearCuenta()">+</button></div></div><div id="listCuentas" class="item-list"></div></div>
    <div class="card"><div class="card-header"><h2>üöÄ Proyectos</h2></div><div id="gridActivos" style="margin-bottom:10px;"></div><div style="flex:1;position:relative;border-top:1px solid #333;padding-top:10px;display:flex;justify-content:center;"><div style="height:250px;width:100%;"><canvas id="chartActivos"></canvas></div></div></div>
    <div class="card"><div class="card-header"><h2>üìù Movimientos</h2><input type="text" id="searchMovs" placeholder="üîç Buscar..." style="width:120px;padding:5px;font-size:11px;margin:0;" onkeyup="filtrarMovimientos()"></div><ul id="listMovs" class="item-list"></ul></div>
</div>

<script>
const $ = id => document.getElementById(id);
let DATA = { cuentas:[], activos:[], movimientos:[], pendientes:[], categorias:[] };
let CURRENT_USER = ''; let IS_ADMIN = false; let currentTipo = 'ingreso'; let chartRef, repChart1, repChart2; let REPORT_CACHE = null; let ALL_USERS=[];
const fmtMoney=n=>new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(n);

// --- DEBTS LOGIC ---
let DEBTS = JSON.parse(localStorage.getItem('erp_debts')) || [];
function openDebts() { $('debts-overlay').style.display='flex'; renderDebts(); }
function addDebt() {
    const name = $('debtName').value; const amount = parseFloat($('debtAmount').value);
    if(!name || !amount) return alert("Completa los datos");
    DEBTS.push({ id: Date.now(), name: name, total: amount, start: new Date().toISOString() });
    localStorage.setItem('erp_debts', JSON.stringify(DEBTS)); $('debtName').value=''; $('debtAmount').value=''; renderDebts();
}
function renderDebts() {
    $('debtsList').innerHTML = DEBTS.map(d => {
        const abonado = DATA.movimientos.filter(m => m.categoria === `Deuda: ${d.name}` && m.tipo === 'gasto').reduce((sum, m) => sum + Math.abs(m.monto), 0);
        const restante = d.total - abonado;
        const progress = Math.min((abonado / d.total) * 100, 100);
        const isPaid = restante <= 0;
        return `<div style="background:#1a1a1a; padding:15px; border-radius:10px; margin-bottom:10px; border:1px solid #333;"><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span style="font-weight:bold; color:#fff;">${d.name}</span><span style="font-size:12px; color:${isPaid?'var(--green)':'var(--orange)'}">${isPaid ? 'PAGADO' : 'PENDIENTE'}</span></div><div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa; margin-bottom:5px;"><span>Abonado: ${fmtMoney(abonado)}</span><span>Total: ${fmtMoney(d.total)}</span></div><div class="progress-track"><div class="progress-fill" style="width:${progress}%; background:${isPaid?'var(--green)':'var(--blue)'}"></div></div>${!isPaid ? `<button class="btn bg-blue btn-small" style="width:100%; margin-top:10px; justify-content:center;" onclick="payDebt('${d.name}')">ABONAR A CAPITAL</button>` : ''}<button class="btn-icon del" style="position:absolute; margin-top:-70px; right:35px;" onclick="deleteDebt(${d.id})">üóëÔ∏è</button></div>`;
    }).join('');
}
function payDebt(name) { $('debts-overlay').style.display='none'; openModal('gasto'); $('desc').value = `Abono a ${name}`; const opt = document.createElement('option'); opt.value = `Deuda: ${name}`; opt.text = `Deuda: ${name}`; $('selCat').add(opt); $('selCat').value = `Deuda: ${name}`; }
function deleteDebt(id) { if(!confirm("¬øEliminar registro?")) return; DEBTS = DEBTS.filter(d => d.id !== id); localStorage.setItem('erp_debts', JSON.stringify(DEBTS)); renderDebts(); }

// --- REPORTES ---
function abrirReportes(){
    try {
        $('reporte-overlay').style.display='flex';
        if(DATA.cuentas) $('report-accounts-list').innerHTML = DATA.cuentas.map(c => `<label style="display:flex;align-items:center;gap:5px;font-size:11px;cursor:pointer;"><input type="checkbox" class="chk-report-account" value="${c._id}" onchange="actualizarReporte()"> ${c.nombre}</label>`).join('');
        actualizarReporte();
    } catch(e) { console.error("Error abriendo reportes", e); $('reporte-overlay').style.display='flex'; }
}

async function actualizarReporte(){
    const anio=$('filtroAnio').value, mes=$('filtroMes').value, activo_id=$('filtroProyecto').value;
    const selected = Array.from(document.querySelectorAll('.chk-report-account:checked')).map(cb => cb.value);
    const cuentas_ids = selected.length > 0 ? selected : 'todas';
    try {
        const r=await fetch('/api/reporte',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({anio,mes,activo_id,user:CURRENT_USER, cuentas_ids})});
        const rep=await r.json(); 
        let tIng = 0, tGas = 0;
        if(rep.detalles) {
            rep.detalles.forEach(m => {
                if(m.monto > 0) tIng += m.monto;
                else tGas += Math.abs(m.monto);
            });
        }
        rep.ingresos = tIng; rep.gastos = tGas; rep.neto = tIng - tGas;
        
        REPORT_CACHE=rep;
        $('repIng').innerText=fmtMoney(rep.ingresos); $('repGas').innerText=fmtMoney(rep.gastos); $('repNeto').innerText=fmtMoney(rep.neto);
        const ctx1=$('chartReporteMain').getContext('2d'); if(repChart1)repChart1.destroy(); 
        repChart1=new Chart(ctx1,{type:'bar',data:{labels:['Ing','Gas','Neto'],datasets:[{data:[rep.ingresos,rep.gastos,rep.neto],backgroundColor:['#22c55e','#ef4444','#3b82f6']}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{grid:{color:'#333'}}}}});
        const ctx2=$('chartReporteCat').getContext('2d'); if(repChart2)repChart2.destroy(); 
        const cats=Object.keys(rep.por_categoria||{}); const vals=Object.values(rep.por_categoria||{}); 
        repChart2=new Chart(ctx2,{type:'doughnut',data:{labels:cats,datasets:[{data:vals,backgroundColor:['#ef4444','#eab308','#3b82f6','#8b5cf6','#06b6d4','#22c55e'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#fff',boxWidth:10}}}}});
    } catch(e){console.error(e);}
}

// --- IMPRESION ---
function imprimirHTML(h){ const p=document.getElementById('print-area'); p.innerHTML=h; window.print(); p.innerHTML=''; }
function imprimirReporte(){
    if(!REPORT_CACHE) return alert("Carga datos");
    const rows = REPORT_CACHE.detalles.map(m => {
        const isGasto = m.tipo === 'gasto' || m.tipo === 'traspaso_salida';
        const colorClass = isGasto ? 'text-red-print' : ''; 
        const signo = isGasto ? '-' : '';
        return `<tr><td>${new Date(m.fecha).toLocaleDateString()}</td><td>${m.descripcion} (${m.categoria||'-'})</td><td>${m.activo_id?m.activo_id.nombre:'General'}</td><td>${m.cuenta_id?m.cuenta_id.nombre:'-'}</td><td class="text-right ${colorClass}">${signo}${fmtMoney(Math.abs(m.monto))}</td></tr>`;
    }).join('');
    const h=`<div class="print-header"><div class="print-logo">REPORTE CTRFAM</div><p>${CURRENT_USER} | ${new Date().toLocaleDateString()}</p></div><div class="print-summary"><div class="print-val-label">ENTRADAS<br><span class="print-val-num">${fmtMoney(REPORT_CACHE.ingresos)}</span></div><div class="print-val-label">SALIDAS<br><span class="print-val-num text-red-print">${fmtMoney(REPORT_CACHE.gastos)}</span></div><div class="print-val-label">NETO<br><span class="print-val-num">${fmtMoney(REPORT_CACHE.neto)}</span></div></div><table class="print-table"><thead><tr><th>Fecha</th><th>Concepto</th><th>Proyecto</th><th>Cuenta</th><th class="text-right">Monto</th></tr></thead><tbody>${rows}</tbody></table>`;
    imprimirHTML(h);
}
function imprimirReporteDeudas() {
    let html = `<div class="print-header"><div class="print-logo">ESTADO DE PASIVOS</div><p>${CURRENT_USER} | ${new Date().toLocaleDateString()}</p></div>`;
    DEBTS.forEach(d => {
        const payments = DATA.movimientos.filter(m => m.categoria === `Deuda: ${d.name}` && m.tipo === 'gasto').sort((a,b) => new Date(a.fecha) - new Date(b.fecha));
        const abonado = payments.reduce((sum, m) => sum + Math.abs(m.monto), 0);
        const restante = d.total - abonado;
        const rows = payments.map(p => `<tr><td>${new Date(p.fecha).toLocaleDateString()}</td><td>${p.descripcion}</td><td class="text-right">${fmtMoney(Math.abs(p.monto))}</td></tr>`).join('');
        html += `<div class="debt-container"><div style="display:flex; justify-content:space-between; border-bottom:2px solid #000; padding-bottom:5px; margin-bottom:10px;"><b style="font-size:14px;">${d.name.toUpperCase()}</b><b style="font-size:14px;">MONTO TOTAL: ${fmtMoney(d.total)}</b></div>${rows ? `<table class="print-table"><thead><tr><th>FECHA</th><th>CONCEPTO</th><th class="text-right">ABONO</th></tr></thead><tbody>${rows}</tbody></table>` : '<p style="font-style:italic; font-size:11px;">Sin abonos.</p>'}<div style="display:flex; justify-content:flex-end; gap:20px; margin-top:10px; font-weight:bold; border-top:1px solid #ccc; padding-top:5px;"><span>PAGADO: ${fmtMoney(abonado)}</span><span style="color:${restante > 0 ? '#d00' : 'green'}">RESTANTE: ${fmtMoney(restante)}</span></div></div>`;
    });
    imprimirHTML(html);
}
function imprimirArqueo(){
    let total=0, items=[];
    document.querySelectorAll('.chk-arqueo:checked').forEach(k=>{ const v=parseFloat(k.value); total+=v; items.push({n:k.dataset.n, s:v}); });
    if(items.length===0) return alert("Selecciona");
    fetch('/api/arqueo',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({usuario:CURRENT_USER,total,detalles:items.map(i=>({cuenta:i.n,saldo:i.s}))})});
    const rows = items.map(i=>`<tr><td>${i.n}</td><td class="text-right">${fmtMoney(i.s)}</td></tr>`).join('');
    const h=`<div class="print-header"><div class="print-logo">CORTE DE CAJA</div><p>${CURRENT_USER} | ${new Date().toLocaleString()}</p></div><table class="print-table"><thead><tr><th>CUENTA / CAJA</th><th class="text-right">SALDO</th></tr></thead><tbody>${rows}</tbody></table><h2 style="text-align:right; margin-top:20px;">TOTAL: ${fmtMoney(total)}</h2><br><br><br><div style="border-top:1px solid #000; width:200px; margin:50px auto; text-align:center;">Firma Responsable</div>`;
    imprimirHTML(h);
}

// --- INIT ---
async function doLogin() { 
    const u=$('user').value, p=$('pass').value; 
    try { const r=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user:u,pass:p})}); const d=await r.json(); if(d.success){CURRENT_USER=d.user;IS_ADMIN=d.es_admin;$('login-overlay').style.display='none';loadData();}else{$('loginError').style.display='block';} }catch(e){alert("Error de conexi√≥n");} 
}
function logout(){location.reload();}
async function loadData(){try{const r=await fetch(`/api/data?user=${CURRENT_USER}`); DATA=await r.json(); renderAll(); populateFilters();}catch(e){console.error(e);}}

function renderAll(){
    $('btnReportes').style.display='flex'; $('totalPatrimonio').innerText=fmtMoney(DATA.patrimonio);
    if(IS_ADMIN){ $('btnAdmin').style.display='flex'; $('btnAddCta').style.display='block'; $('btnDebts').style.display='flex'; }
    else{ $('btnAdmin').style.display='none'; $('btnAddCta').style.display='none'; $('btnDebts').style.display='none'; }
    $('radar-alertas').innerHTML=DATA.pendientes.map(m=>`<div style="background:rgba(255,215,0,0.1);border:1px solid var(--yellow);padding:10px;border-radius:8px;display:flex;justify-content:space-between;color:var(--yellow);align-items:center;"><div><strong>‚ö†Ô∏è REEMBOLSO: ${fmtMoney(Math.abs(m.monto))}</strong><br><span style="font-size:11px;">${m.descripcion}</span></div><button class="btn bg-green btn-small" onclick="confirmarReembolso('${m._id}')">‚úÖ</button></div>`).join('');
    $('radar-alertas').style.display = DATA.pendientes.length ? 'flex' : 'none';
    $('listCuentas').innerHTML=DATA.cuentas.map(c=>`<div class="item-row"><div><span>${c.icono} ${c.nombre}</span> <span style="font-weight:bold;margin-left:10px;">${fmtMoney(c.saldo)}</span></div>${IS_ADMIN?`<div style="display:flex;gap:5px;"><button class="btn-icon edit" onclick="editarCuenta('${c._id}','${c.nombre}')">‚úèÔ∏è</button><button class="btn-icon del" onclick="borrarCuenta('${c._id}')">üóëÔ∏è</button></div>`:''}</div>`).join('');
    $('gridActivos').innerHTML=DATA.activos.map(a=>`<div class="item-row"><div>${a.icono} ${a.nombre}</div><div style="font-weight:bold;color:${a.balance_total>=0?'var(--green)':'var(--red)'}">${fmtMoney(a.balance_total)}</div></div>`).join('');
    renderMovs(DATA.movimientos); updateChart(); populateSelects();
}

function renderMovs(movs) {
    $('listMovs').innerHTML=movs.map(m=> { 
        let c='var(--green)'; if(m.tipo==='gasto')c='var(--red)'; if(m.estado!=='finalizado')c='var(--yellow)'; if(m.tipo.includes('traspaso'))c='var(--cyan)'; 
        let actions = ``;
        if(IS_ADMIN || m.creado_por === CURRENT_USER) { actions = `<div style="display:flex;gap:5px;margin-top:5px;"><button class="btn-icon edit" onclick='editarMov(${JSON.stringify(m)})'>‚úèÔ∏è</button><button class="btn-icon del" onclick="borrarMov('${m._id}')">üóëÔ∏è</button></div>`; }
        return `<li style="opacity:${m.estado==='reembolsado'?0.5:1}; padding:10px; border-bottom:1px solid #222;">
            <div style="display:flex; justify-content:space-between;">
                <div><span style="display:block;font-size:13px;font-weight:600;">${m.descripcion}</span><span style="font-size:11px;color:#666;">${new Date(m.fecha).toLocaleDateString()} | ${m.categoria||'-'} | ${m.creado_por}</span></div>
                <span style="font-weight:bold;color:${c}">${fmtMoney(m.monto)}</span>
            </div>
            ${actions}
        </li>` 
    }).join('');
}
function filtrarMovimientos() { const q=$('searchMovs').value.toLowerCase(); renderMovs(DATA.movimientos.filter(m=>m.descripcion.toLowerCase().includes(q)||m.monto.toString().includes(q))); }

// ADMIN
function abrirAdmin(){ $('admin-overlay').style.display='flex'; switchTab('personal'); cargarUsuariosUI(); cargarProyectosAdmin(); renderCatsAdmin(); }
function switchTab(t){
    document.querySelectorAll('.tab-section').forEach(e=>e.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
    const panel = document.getElementById(`tab-${t}`); const btn = document.getElementById(`btn-tab-${t}`);
    if(panel) panel.classList.add('active'); if(btn) btn.classList.add('active');
}
async function cargarUsuariosUI(){ const r=await fetch('/api/usuarios'); ALL_USERS=await r.json(); 
$('checklistProyectos').innerHTML=DATA.activos.map(a=>`<div class="check-item"><input type="checkbox" class="chk-proy" value="${a._id}" id="chk_u_${a._id}"> ${a.nombre}</div>`).join(''); 
$('listaUsuarios').innerHTML=ALL_USERS.map(u=>`<div class="item-row"><b>${u.user}</b> <div class="flex-row"><button class="btn-icon edit" onclick="editarUsuario('${u._id}')">‚úèÔ∏è</button><button class="btn-icon del" onclick="borrarUsuario('${u._id}')">üóëÔ∏è</button></div></div>`).join(''); }
async function borrarUsuario(id){ if(confirm("¬øEliminar usuario?")) await fetch(`/api/usuarios/${id}`,{method:'DELETE'}); cargarUsuariosUI(); }
function editarUsuario(id){ const u=ALL_USERS.find(x=>x._id===id); $('userIdEdit').value=id; $('userTitle').innerText="EDITAR: "+u.user; $('new_user').value=u.user; $('new_fullname').value=u.nombre_completo; $('new_pass').value=''; document.querySelectorAll('.chk-proy').forEach(c=>c.checked=false); if(u.proyectos_permitidos) u.proyectos_permitidos.forEach(p=>{ const k=$(`chk_u_${p._id}`); if(k)k.checked=true; }); }
async function guardarUsuario(){ const id=$('userIdEdit').value, u=$('new_user').value, p=$('new_pass').value, f=$('new_fullname').value, ps=Array.from(document.querySelectorAll('.chk-proy:checked')).map(c=>c.value); if(!u)return; const url=id?`/api/usuarios/${id}`:'/api/usuarios'; const method=id?'PUT':'POST'; await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify({user:u,pass:p,nombre_completo:f,proyectos:ps})}); $('userIdEdit').value=''; $('userTitle').innerText="NUEVO COLABORADOR"; $('new_user').value=''; $('new_fullname').value=''; $('new_pass').value=''; cargarUsuariosUI(); }
function cargarProyectosAdmin() { $('checklistCuentasProy').innerHTML=DATA.cuentas.map(c=>`<div class="check-item"><input type="checkbox" class="chk-cta-proy" value="${c._id}" id="chk_cta_${c._id}"> ${c.nombre}</div>`).join(''); 
$('listaProyectosAdmin').innerHTML=DATA.activos.map(a=>`<div class="item-row"><b>${a.nombre}</b> <div class="flex-row"><button class="btn-icon edit" onclick="editarProyecto('${a._id}')">‚úèÔ∏è</button><button class="btn-icon del" onclick="borrarActivo('${a._id}')">üóëÔ∏è</button></div></div>`).join(''); }
function editarProyecto(id) { const p=DATA.activos.find(x=>x._id===id); $('proyIdEdit').value=id; $('proyTitle').innerText="EDITAR: "+p.nombre; $('proyNombre').value=p.nombre; document.querySelectorAll('.chk-cta-proy').forEach(c=>c.checked=false); if(p.cuentas_asociadas) p.cuentas_asociadas.forEach(c=>{ const k=$(`chk_cta_${c._id}`); if(k)k.checked=true; }); }
async function guardarActivoFull() { const id=$('proyIdEdit').value, n=$('proyNombre').value, cs=Array.from(document.querySelectorAll('.chk-cta-proy:checked')).map(c=>c.value); if(!n)return; const url=id?`/api/activos/${id}`:'/api/activos'; const method=id?'PUT':'POST'; await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n,cuentas:cs})}); $('proyIdEdit').value=''; $('proyTitle').innerText="NUEVO PROYECTO"; $('proyNombre').value=''; loadData().then(cargarProyectosAdmin); }
function renderCatsAdmin(){ $('newCatProy').innerHTML='<option value="">-- General --</option>'+DATA.activos.map(a=>`<option value="${a._id}">${a.nombre}</option>`).join(''); let l=DATA.categorias; const f=$('catFilterProy').value; if($('catFilterProy').options.length===1){DATA.activos.forEach(a=>{$('catFilterProy').appendChild(new Option(a.nombre,a._id))});$('catFilterProy').appendChild(new Option('General','general'));} if(f!=='all'){if(f==='general')l=l.filter(c=>!c.proyecto_id);else l=l.filter(c=>c.proyecto_id&&c.proyecto_id._id===f);} $('listaCatsAdmin').innerHTML=l.map(c=>`<li class="item-row"><span>${c.nombre} <small>(${c.tipo}) [${c.proyecto_id?c.proyecto_id.nombre:'General'}]</small></span><button class="btn-icon del" onclick="borrarCat('${c._id}')">üóëÔ∏è</button></li>`).join(''); }
async function crearCat(){ const n=$('newCatName').value, t=$('newCatType').value, p=$('newCatProy').value; if(n) await fetch('/api/categorias',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n, tipo:t, proyecto_id:p || null})}); $('newCatName').value=''; loadData().then(renderCatsAdmin); }
async function borrarCat(id){ if(confirm("Borrar?")) await fetch(`/api/categorias/${id}`,{method:'DELETE'}); loadData().then(renderCatsAdmin); }
function openModal(t){ 
    $('movIdEdit').value = ''; $('createFields').style.display = 'block'; currentTipo=t; 
    $('modal').style.display='flex'; $('tipoTxt').value=t.toUpperCase(); $('desc').value=''; $('monto').value=''; 
    $('fechaMov').value = new Date().toISOString().split('T')[0];
    if(t==='gasto')$('divReembolso').style.display='block';else $('divReembolso').style.display='none'; 
    filtrarCategorias(); 
}
function filtrarCategorias() { const projId = $('selActivo').value; const cats = DATA.categorias.filter(c => { if(projId === "") return !c.proyecto_id && c.tipo === currentTipo; return c.tipo === currentTipo && (!c.proyecto_id || c.proyecto_id._id === projId); }); $('selCat').innerHTML = cats.length ? cats.map(c=>`<option value="${c.nombre}">${c.nombre}</option>`).join('') : '<option value="General">General</option>'; }
function populateSelects(){ $('selCuenta').innerHTML=DATA.cuentas.map(c=>`<option value="${c._id}">${c.nombre} ($${c.saldo})</option>`).join(''); $('selActivo').innerHTML = (IS_ADMIN?`<option value="">-- Personal --</option>`:'') + DATA.activos.map(a=>`<option value="${a._id}">${a.nombre}</option>`).join('') + '<option value="">--- Otros / Varios ---</option>'; }
async function guardarMovimiento(){ 
    const d=$('desc').value; if(!d) return alert("Concepto obligatorio"); 
    const id = $('movIdEdit').value; const p = $('selActivo').value; 
    const body = { 
        descripcion:d, monto:$('monto').value, tipo:currentTipo, categoria:$('selCat').value, 
        usuario_actual:CURRENT_USER, fecha: $('fechaMov').value 
    }; 
    if(id) { await fetch(`/api/movimiento/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)}); } 
    else { body.cuenta_id = $('selCuenta').value; body.activo_id = p || null; body.estado = ($('chkReembolso').checked && currentTipo==='gasto') ? 'pendiente_reembolso' : 'finalizado'; await fetch('/api/movimiento', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)}); } 
    document.getElementById('modal').style.display='none'; loadData(); 
}
async function borrarMov(id) { if(!confirm("¬øSeguro?")) return; await fetch(`/api/movimiento/${id}`, {method:'DELETE'}); loadData(); }
function editarMov(m) { 
    if(m.tipo.includes('traspaso')) return alert("Borra y crea de nuevo los traspasos."); 
    $('movIdEdit').value = m._id; $('desc').value = m.descripcion; $('monto').value = Math.abs(m.monto); $('tipoTxt').value = m.tipo.toUpperCase(); currentTipo = m.tipo; 
    $('fechaMov').value = m.fecha.split('T')[0];
    $('createFields').style.display = 'none'; const projId = m.activo_id ? m.activo_id._id : ''; const cats = DATA.categorias.filter(c => c.tipo === currentTipo && (!c.proyecto_id || c.proyecto_id._id === projId)); $('selCat').innerHTML = cats.length ? cats.map(c=>`<option value="${c.nombre}">${c.nombre}</option>`).join('') : '<option value="General">General</option>'; $('selCat').value = m.categoria; $('modal').style.display='flex'; 
}
function closeModal(){$('modal').style.display='none';}
async function confirmarReembolso(id){if(!confirm("?"))return;await fetch('/api/confirmar-reembolso',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mov_id:id,usuario_actual:CURRENT_USER})});loadData();}
function abrirArqueo(){$('arqueo-overlay').style.display='flex';$('listaArqueo').innerHTML=DATA.cuentas.map(c=>`<div class="item-row"><label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:13px;"><input type="checkbox" class="chk-arqueo" value="${c.saldo}" data-n="${c.nombre}" onchange="calcArq()"> ${c.nombre}</label> <strong>${fmtMoney(c.saldo)}</strong></div>`).join('');calcArq();}
function calcArq(){let t=0;document.querySelectorAll('.chk-arqueo:checked').forEach(k=>{t+=parseFloat(k.value)});$('totalArqueo').innerText=fmtMoney(t);}
function abrirTraspaso(){$('traspaso-overlay').style.display='flex';const o=DATA.cuentas.map(c=>`<option value="${c._id}">${c.nombre}</option>`).join('');$('trasOrigen').innerHTML=o;$('trasDestino').innerHTML=o;$('trasProyecto').innerHTML=DATA.activos.map(a=>`<option value="${a._id}">${a.nombre}</option>`).join('');}
async function ejecutarTraspaso(){const o=$('trasOrigen').value,d=$('trasDestino').value,m=$('trasMonto').value,desc=$('trasDesc').value,p=$('trasProyecto').value;if(o===d||!m)return;await fetch('/api/traspaso',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({origen_id:o,destino_id:d,monto:m,descripcion:desc,usuario_actual:CURRENT_USER,activo_id:p})});$('traspaso-overlay').style.display='none';loadData();}
function abrirCatsUser() { $('cats-overlay').style.display='flex'; $('u-catProy').innerHTML = '<option value="">--- General / Otros ---</option>' + DATA.activos.map(a => `<option value="${a._id}">${a.nombre}</option>`).join(''); renderCatsUser(); }
function renderCatsUser() { const list = DATA.categorias.filter(c => (!c.proyecto_id || DATA.activos.some(a => a._id === c.proyecto_id._id))); $('u-listaCats').innerHTML=list.map(c=>`<div class="item-row"><span>${c.nombre} <small style="color:var(--muted)">(${c.tipo})</small></span> <button class="btn-icon del" onclick="borrarCatUser('${c._id}')">üóëÔ∏è</button></div>`).join(''); }
async function crearCatUser() { const n=$('u-catName').value, t=$('u-catType').value, p=$('u-catProy').value; if(!n) return alert("Nombre requerido"); await fetch('/api/categorias',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n, tipo:t, proyecto_id:p || null})}); $('u-catName').value=''; loadData().then(renderCatsUser); }
async function borrarCatUser(id) { if(confirm("Borrar?")) await fetch(`/api/categorias/${id}`,{method:'DELETE'}); loadData().then(renderCatsUser); }
async function crearCuenta(){const n=prompt("Nombre:");if(n)await fetch('/api/cuentas',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})});loadData();}
async function editarCuenta(id,o){const n=prompt("Nombre:",o);if(n)await fetch(`/api/cuentas/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})});loadData();}
async function borrarCuenta(id){if(confirm("X"))await fetch(`/api/cuentas/${id}`,{method:'DELETE'});loadData();}
async function borrarActivo(id){if(confirm("X"))await fetch(`/api/activos/${id}`,{method:'DELETE'});loadData().then(cargarProyectosAdmin);}
async function descargarBackup() { const r=await fetch(`/api/backup?user=${CURRENT_USER}`); const d=await r.json(); const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=`Backup.json`; a.click(); }
async function restaurarBackup(input) { if(!confirm("‚ö†Ô∏è SE BORRAR√Å TODO. ¬øSEGURO?")) return; const f=input.files[0]; const reader=new FileReader(); reader.onload=async(e)=>{ try{ const data=JSON.parse(e.target.result); await fetch('/api/restore',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data, user:CURRENT_USER})}); alert("Restauraci√≥n OK. Recargando..."); location.reload(); }catch(err){alert("Error");} }; reader.readAsText(f); }
function updateChart(){const ctx=$('chartActivos').getContext('2d');if(chartRef)chartRef.destroy();const ac=DATA.activos.filter(a=>a.balance_total>0);chartRef=new Chart(ctx,{type:'doughnut',data:{labels:ac.map(a=>a.nombre),datasets:[{data:ac.map(a=>a.balance_total),borderWidth:0,backgroundColor:['#22c55e','#3b82f6','#ef4444','#eab308']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#fff',boxWidth:10}}}}});}
function populateFilters(){ if(DATA.activos) $('filtroProyecto').innerHTML='<option value="todos">Todos</option>'+DATA.activos.map(a=>`<option value="${a._id}">${a.nombre}</option>`).join(''); }
</script>
</body>
</html>
