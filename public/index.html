<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ERP Financiero | Master Control</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root { --bg:#050505; --card:#111; --text:#fff; --gray:#888; --green:#00e676; --red:#ff1744; --blue:#2979ff; --border:#222; }
    body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; margin:0; padding:20px; height:100vh; box-sizing:border-box; display:flex; flex-direction:column; overflow:hidden; }
    
    /* LOGIN SCREEN */
    #login-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    .login-box { width:300px; text-align:center; }
    .login-input { width:100%; padding:15px; background:#111; border:1px solid #333; color:#fff; margin-bottom:10px; border-radius:8px; font-size:16px; text-align:center; }
    
    /* RESTO DEL DISE√ëO */
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .grid { display:grid; grid-template-columns: 300px 1fr 350px; gap:20px; height:100%; overflow:hidden; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:15px; display:flex; flex-direction:column; overflow:hidden; }
    h2 { font-size:14px; color:var(--gray); text-transform:uppercase; margin:0 0 15px 0; border-bottom:1px solid var(--border); padding-bottom:10px; }
    .big-number { font-size:32px; font-weight:800; letter-spacing:-1px; }
    ul { list-style:none; padding:0; margin:0; overflow-y:auto; flex:1; }
    li { display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #222; }
    .btn { border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:700; font-size:12px; width:100%; margin-bottom:10px; display:flex; justify-content:center; gap:8px; }
    .btn-green { background:var(--green); color:#000; } 
    .btn-red { background:rgba(255,23,68,0.15); color:var(--red); border:1px solid var(--red); }
    .btn-blue { background:rgba(41,121,255,0.15); color:var(--blue); border:1px solid var(--blue); }

    /* MODAL */
    #modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99; display:none; justify-content:center; align-items:center; backdrop-filter:blur(5px); }
    .modal-box { background:#151515; border:1px solid #333; width:400px; padding:25px; border-radius:12px; }
    input, select { width:100%; padding:12px; background:#000; border:1px solid #333; color:#fff; border-radius:6px; margin-bottom:15px; box-sizing:border-box; }
    .form-row { display:flex; gap:10px; }
    
    @media (max-width: 1000px) { .grid { grid-template-columns:1fr; grid-template-rows: auto auto auto; overflow-y:auto; } body { overflow-y:auto; height:auto; } }
</style>
</head>
<body>

<div id="login-overlay">
    <div style="font-size:40px; margin-bottom:20px;">üîí</div>
    <div class="login-box">
        <h2 style="border:none; color:#fff;">ACCESO RESTRINGIDO</h2>
        <input type="text" id="user" class="login-input" placeholder="Usuario">
        <input type="password" id="pass" class="login-input" placeholder="Contrase√±a">
        <button class="btn btn-green" onclick="doLogin()">ENTRAR AL SISTEMA</button>
        <p id="loginError" style="color:var(--red); font-size:12px; display:none;">Credenciales incorrectas</p>
    </div>
</div>

<div class="top-bar">
    <div>
        <div style="font-size:12px; color:var(--gray); font-weight:600;">PATRIMONIO NETO</div>
        <div class="big-number" id="totalPatrimonio">$0.00</div>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="btn btn-green" style="width:auto; padding:10px 20px;" onclick="openModal('ingreso')">‚¨Ü INGRESAR</button>
        <button class="btn btn-red" style="width:auto; padding:10px 20px;" onclick="openModal('gasto')">‚¨á GASTAR</button>
        <button class="btn" style="width:auto; background:#333; color:#fff;" onclick="crearUsuarioNuevo()">üë§ +</button>
    </div>
</div>

<div class="grid">
    <div class="card">
        <h2>üè¶ Mis Cuentas</h2>
        <div id="listCuentas"></div>
        <button class="btn btn-blue" onclick="crearCuenta()">+ Nueva Cuenta</button>
    </div>
    <div class="card">
        <h2>üöÄ Activos & Proyectos</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;" id="gridActivos"></div>
        <div style="flex:1; border-top:1px solid #222; padding-top:10px;">
            <canvas id="chartActivos"></canvas>
        </div>
        <button class="btn btn-blue" onclick="crearActivo()">+ Nuevo Proyecto</button>
    </div>
    <div class="card">
        <h2>üìù Movimientos</h2>
        <ul id="listMovs"></ul>
    </div>
</div>

<div id="modal">
    <div class="modal-box">
        <h2 id="modalTitle" style="color:var(--text); border:none;">Registrar</h2>
        <label>Descripci√≥n</label><input type="text" id="desc">
        <div class="form-row">
            <div style="flex:1"><label>Monto ($)</label><input type="number" id="monto"></div>
            <div style="flex:1"><label>Tipo</label><input type="text" id="tipoTxt" readonly style="color:#888;"></div>
        </div>
        <label>Cuenta</label><select id="selCuenta"></select>
        <label>Proyecto (Opcional)</label><select id="selActivo"></select>
        <div class="form-row" style="margin-top:20px;">
            <button class="btn btn-green" onclick="guardarMovimiento()">GUARDAR</button>
            <button class="btn btn-red" onclick="closeModal()">CANCELAR</button>
        </div>
    </div>
</div>

<script>
const $ = id => document.getElementById(id);
let DATA = { cuentas:[], activos:[], movimientos:[] };
let currentTipo = 'ingreso';

// --- LOGIN ---
async function doLogin() {
    const user = $('user').value;
    const pass = $('pass').value;
    
    try {
        const res = await fetch('/api/login', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ user, pass })
        });
        const data = await res.json();
        
        if (data.success) {
            $('login-overlay').style.display = 'none'; // Quitar candado
            loadData(); // Cargar finanzas
        } else {
            $('loginError').style.display = 'block';
        }
    } catch(e) { alert("Error de conexi√≥n"); }
}

async function crearUsuarioNuevo() {
    const nuevoUser = prompt("Nuevo nombre de usuario:");
    const nuevoPass = prompt("Nueva contrase√±a:");
    if(nuevoUser && nuevoPass) {
        await fetch('/api/usuarios', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user:nuevoUser, pass:nuevoPass}) });
        alert("Usuario creado correctamente");
    }
}

// --- LOGICA PRINCIPAL ---
async function loadData() {
    try {
        const res = await fetch('/api/data');
        DATA = await res.json();
        renderAll();
    } catch(e) { console.error("Error cargando"); }
}

function renderAll() {
    $('totalPatrimonio').innerText = fmtMoney(DATA.patrimonio);
    
    $('listCuentas').innerHTML = DATA.cuentas.map(c => `
        <div style="background:#1a1a1a; padding:15px; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
            <span>${c.icono} ${c.nombre}</span>
            <span style="font-weight:bold;">${fmtMoney(c.saldo)}</span>
        </div>`).join('');

    $('gridActivos').innerHTML = DATA.activos.map(a => `
        <div style="background:#151515; border:1px solid #333; padding:10px; border-radius:8px;">
            <div style="font-size:11px; color:#888;">${a.icono} ${a.nombre}</div>
            <div style="font-size:15px; font-weight:bold; color:${a.balance_total>=0?'var(--green)':'var(--red)'}">${fmtMoney(a.balance_total)}</div>
        </div>`).join('');

    $('listMovs').innerHTML = DATA.movimientos.map(m => `
        <li>
            <div>
                <span style="display:block; font-size:13px; font-weight:600;">${m.descripcion}</span>
                <span style="font-size:11px; color:#666;">${m.cuenta_id ? m.cuenta_id.nombre : ''}</span>
            </div>
            <span style="font-weight:bold; color:${m.tipo=='ingreso'?'var(--green)':'var(--red)'}">
                ${m.tipo=='ingreso'?'+':'-'}${fmtMoney(Math.abs(m.monto))}
            </span>
        </li>`).join('');
    
    updateChart(); populateSelects();
}

async function guardarMovimiento() {
    const desc = $('desc').value; const monto = parseFloat($('monto').value);
    const cuenta_id = $('selCuenta').value; const activo_id = $('selActivo').value || null;
    if(!desc || !monto || !cuenta_id) return alert("Faltan datos");
    
    await fetch('/api/movimiento', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ descripcion:desc, monto, cuenta_id, activo_id, tipo:currentTipo }) });
    closeModal(); loadData();
}

async function crearCuenta() { const n = prompt("Nombre Cuenta:"); if(n) { await fetch('/api/cuentas', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})}); loadData(); }}
async function crearActivo() { const n = prompt("Nombre Proyecto:"); if(n) { await fetch('/api/activos', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})}); loadData(); }}

const fmtMoney = num => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(num);
function openModal(t) { currentTipo=t; $('modal').style.display='flex'; $('tipoTxt').value=t.toUpperCase(); $('desc').value=''; $('monto').value=''; }
function closeModal() { $('modal').style.display='none'; }
function populateSelects() {
    $('selCuenta').innerHTML = DATA.cuentas.map(c => `<option value="${c._id}">${c.nombre} ($${c.saldo})</option>`).join('');
    $('selActivo').innerHTML = `<option value="">-- Personal --</option>` + DATA.activos.map(a => `<option value="${a._id}">${a.nombre}</option>`).join('');
}

let chartRef;
function updateChart() {
    const ctx = $('chartActivos').getContext('2d');
    if(chartRef) chartRef.destroy();
    const activos = DATA.activos.filter(a => a.balance_total > 0);
    chartRef = new Chart(ctx, { type:'doughnut', data:{ labels:activos.map(a=>a.nombre), datasets:[{data:activos.map(a=>a.balance_total), borderWidth:0, backgroundColor:['#00e676','#2979ff','#ff1744','#ffd700']}] }, options:{responsive:true, plugins:{legend:{position:'right', labels:{color:'#fff',boxWidth:10}}}} });
}
</script>
</body>
</html>
