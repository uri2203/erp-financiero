<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ERP Financiero | Master Control</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root { --bg:#050505; --card:#111; --text:#fff; --gray:#888; --green:#00e676; --red:#ff1744; --blue:#2979ff; --border:#222; }
    body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; margin:0; padding:20px; height:100vh; box-sizing:border-box; display:flex; flex-direction:column; overflow:hidden; }
    
    /* LOGIN & MODALS */
    #login-overlay, #reporte-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    #reporte-overlay { background:rgba(0,0,0,0.95); z-index:9998; display:none; } /* Oculto por defecto */
    
    .login-box { width:300px; text-align:center; }
    .reporte-box { width:90%; max-width:800px; height:80vh; background:#111; border:1px solid #333; border-radius:15px; padding:20px; display:flex; flex-direction:column; }
    .login-input { width:100%; padding:15px; background:#111; border:1px solid #333; color:#fff; margin-bottom:10px; border-radius:8px; font-size:16px; text-align:center; }
    
    /* LAYOUT */
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .grid { display:grid; grid-template-columns: 300px 1fr 350px; gap:20px; height:100%; overflow:hidden; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:15px; display:flex; flex-direction:column; overflow:hidden; }
    h2 { font-size:14px; color:var(--gray); text-transform:uppercase; margin:0 0 15px 0; border-bottom:1px solid var(--border); padding-bottom:10px; }
    .big-number { font-size:32px; font-weight:800; letter-spacing:-1px; }
    ul { list-style:none; padding:0; margin:0; overflow-y:auto; flex:1; }
    li { display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #222; }
    .btn { border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:700; font-size:12px; display:flex; justify-content:center; align-items:center; gap:8px; transition:0.2s; }
    .btn:hover { opacity:0.8; }
    .btn-green { background:var(--green); color:#000; } 
    .btn-red { background:rgba(255,23,68,0.15); color:var(--red); border:1px solid var(--red); }
    .btn-blue { background:rgba(41,121,255,0.15); color:var(--blue); border:1px solid var(--blue); }
    .btn-gold { background:rgba(255, 215, 0, 0.15); color:#ffd700; border:1px solid #ffd700; }

    /* CONTROLES REPORTE */
    .filter-bar { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
    .filter-select { background:#000; color:#fff; border:1px solid #333; padding:10px; border-radius:6px; flex:1; }

    /* MODAL REGISTRO */
    #modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99; display:none; justify-content:center; align-items:center; backdrop-filter:blur(5px); }
    .modal-box { background:#151515; border:1px solid #333; width:400px; padding:25px; border-radius:12px; }
    input, select { width:100%; padding:12px; background:#000; border:1px solid #333; color:#fff; border-radius:6px; margin-bottom:15px; box-sizing:border-box; }
    .form-row { display:flex; gap:10px; }
    
    @media (max-width: 1000px) { .grid { grid-template-columns:1fr; grid-template-rows: auto auto auto; overflow-y:auto; } body { overflow-y:auto; height:auto; } }
</style>
</head>
<body>

<div id="login-overlay">
    <div style="font-size:40px; margin-bottom:20px;">üîí</div>
    <div class="login-box">
        <h2 style="border:none; color:#fff;">SISTEMA BLINDADO</h2>
        <input type="text" id="user" class="login-input" placeholder="Usuario">
        <input type="password" id="pass" class="login-input" placeholder="Contrase√±a">
        <button class="btn btn-green" style="width:100%" onclick="doLogin()">ENTRAR AL SISTEMA</button>
        <p id="loginError" style="color:var(--red); font-size:12px; display:none;">Credenciales incorrectas</p>
    </div>
</div>

<div id="reporte-overlay">
    <div class="reporte-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="border:none; margin:0; font-size:20px; color:#fff;">üìä Inteligencia de Negocios</h2>
            <button class="btn btn-red" style="width:auto; padding:5px 15px;" onclick="cerrarReportes()">X CERRAR</button>
        </div>

        <div class="filter-bar">
            <select id="filtroAnio" class="filter-select" onchange="actualizarReporte()">
                <option value="2026">2026</option>
                <option value="2025">2025</option>
            </select>
            <select id="filtroMes" class="filter-select" onchange="actualizarReporte()">
                <option value="todos">Todo el A√±o</option>
                <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
            </select>
            <select id="filtroProyecto" class="filter-select" onchange="actualizarReporte()">
                <option value="todos">Todos los Proyectos</option>
                </select>
        </div>

        <div style="flex:1; position:relative;">
            <canvas id="chartReporteMain"></canvas>
        </div>
        
        <div style="display:flex; gap:20px; margin-top:20px; border-top:1px solid #333; padding-top:15px;">
            <div style="text-align:center; flex:1;">
                <div style="color:var(--green); font-weight:bold;">INGRESOS</div>
                <div id="repIng" style="font-size:20px;">$0.00</div>
            </div>
            <div style="text-align:center; flex:1;">
                <div style="color:var(--red); font-weight:bold;">GASTOS</div>
                <div id="repGas" style="font-size:20px;">$0.00</div>
            </div>
            <div style="text-align:center; flex:1;">
                <div style="color:#fff; font-weight:bold;">UTILIDAD NETA</div>
                <div id="repNeto" style="font-size:20px;">$0.00</div>
            </div>
        </div>
    </div>
</div>

<div class="top-bar">
    <div>
        <div style="font-size:12px; color:var(--gray); font-weight:600;">PATRIMONIO NETO TOTAL</div>
        <div class="big-number" id="totalPatrimonio">$0.00</div>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="btn btn-gold" style="width:auto; padding:10px 20px;" onclick="abrirReportes()">üìä REPORTES</button>
        <button class="btn btn-green" style="width:auto; padding:10px 20px;" onclick="openModal('ingreso')">‚¨Ü INGRESAR</button>
        <button class="btn btn-red" style="width:auto; padding:10px 20px;" onclick="openModal('gasto')">‚¨á GASTAR</button>
        <button class="btn" style="width:auto; background:#333; color:#fff;" onclick="crearUsuarioNuevo()">üë§</button>
    </div>
</div>

<div class="grid">
    <div class="card">
        <h2>üè¶ Mis Cuentas</h2>
        <div id="listCuentas"></div>
        <button class="btn btn-blue" onclick="crearCuenta()">+ Nueva Cuenta</button>
    </div>
    <div class="card">
        <h2>üöÄ Activos & Proyectos</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;" id="gridActivos"></div>
        <div style="flex:1; border-top:1px solid #222; padding-top:10px;">
            <canvas id="chartActivos"></canvas>
        </div>
        <button class="btn btn-blue" onclick="crearActivo()">+ Nuevo Proyecto</button>
    </div>
    <div class="card">
        <h2>üìù Movimientos</h2>
        <ul id="listMovs"></ul>
    </div>
</div>

<div id="modal">
    <div class="modal-box">
        <h2 id="modalTitle" style="color:var(--text); border:none;">Registrar</h2>
        <label>Descripci√≥n</label><input type="text" id="desc">
        <div class="form-row">
            <div style="flex:1"><label>Monto ($)</label><input type="number" id="monto"></div>
            <div style="flex:1"><label>Tipo</label><input type="text" id="tipoTxt" readonly style="color:#888;"></div>
        </div>
        <label>Cuenta</label><select id="selCuenta"></select>
        <label>Proyecto (Opcional)</label><select id="selActivo"></select>
        <div class="form-row" style="margin-top:20px;">
            <button class="btn btn-green" onclick="guardarMovimiento()">GUARDAR</button>
            <button class="btn btn-red" onclick="closeModal()">CANCELAR</button>
        </div>
    </div>
</div>

<script>
const $ = id => document.getElementById(id);
let DATA = { cuentas:[], activos:[], movimientos:[] };
let currentTipo = 'ingreso';
let reportChartRef = null;

// --- LOGIN ---
async function doLogin() {
    const user = $('user').value; const pass = $('pass').value;
    try {
        const res = await fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user,pass})});
        const data = await res.json();
        if (data.success) { $('login-overlay').style.display='none'; loadData(); } else { $('loginError').style.display='block'; }
    } catch(e) { alert("Error Conexi√≥n"); }
}
async function crearUsuarioNuevo() { const u=prompt("User:"); const p=prompt("Pass:"); if(u&&p) fetch('/api/usuarios',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user:u,pass:p})}).then(()=>alert("Creado")); }

// --- DATA ---
async function loadData() {
    try {
        const res = await fetch('/api/data'); DATA = await res.json();
        renderAll(); populateFilters();
    } catch(e) { console.error("Error cargando"); }
}

function renderAll() {
    $('totalPatrimonio').innerText = fmtMoney(DATA.patrimonio);
    $('listCuentas').innerHTML = DATA.cuentas.map(c => `<div style="background:#1a1a1a; padding:15px; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;"><span>${c.icono} ${c.nombre}</span><span style="font-weight:bold;">${fmtMoney(c.saldo)}</span></div>`).join('');
    $('gridActivos').innerHTML = DATA.activos.map(a => `<div style="background:#151515; border:1px solid #333; padding:10px; border-radius:8px;"><div style="font-size:11px; color:#888;">${a.icono} ${a.nombre}</div><div style="font-size:15px; font-weight:bold; color:${a.balance_total>=0?'var(--green)':'var(--red)'}">${fmtMoney(a.balance_total)}</div></div>`).join('');
    $('listMovs').innerHTML = DATA.movimientos.map(m => `<li><div><span style="display:block; font-size:13px; font-weight:600;">${m.descripcion}</span><span style="font-size:11px; color:#666;">${m.cuenta_id?m.cuenta_id.nombre:''}</span></div><span style="font-weight:bold; color:${m.tipo=='ingreso'?'var(--green)':'var(--red)'}">${m.tipo=='ingreso'?'+':'-'}${fmtMoney(Math.abs(m.monto))}</span></li>`).join('');
    updateChart(); populateSelects();
}

// --- LOGICA REPORTES ---
function abrirReportes() { $('reporte-overlay').style.display = 'flex'; actualizarReporte(); }
function cerrarReportes() { $('reporte-overlay').style.display = 'none'; }

function populateFilters() {
    const selector = $('filtroProyecto');
    // Mantener la opci√≥n "Todos" y agregar los din√°micos
    selector.innerHTML = '<option value="todos">Todos los Proyectos</option>' + 
        DATA.activos.map(a => `<option value="${a._id}">${a.nombre}</option>`).join('');
}

async function actualizarReporte() {
    const anio = $('filtroAnio').value;
    const mes = $('filtroMes').value;
    const activo_id = $('filtroProyecto').value;

    const res = await fetch('/api/reporte', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ anio, mes, activo_id })
    });
    const reporte = await res.json();

    // Actualizar N√∫meros
    $('repIng').innerText = fmtMoney(reporte.ingresos);
    $('repGas').innerText = fmtMoney(reporte.gastos);
    $('repNeto').innerText = fmtMoney(reporte.neto);
    $('repNeto').style.color = reporte.neto >= 0 ? 'var(--green)' : 'var(--red)';

    // Actualizar Gr√°fica Barras
    const ctx = $('chartReporteMain').getContext('2d');
    if(reportChartRef) reportChartRef.destroy();

    reportChartRef = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Ingresos', 'Gastos', 'Utilidad'],
            datasets: [{
                label: 'Flujo de Dinero',
                data: [reporte.ingresos, reporte.gastos, reporte.neto],
                backgroundColor: ['#00e676', '#ff1744', '#2979ff'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { grid: { color: '#333' }, ticks: { color: '#888' } }, x: { ticks: { color: '#fff' } } }
        }
    });
}

// --- ACCIONES GENERALES ---
async function guardarMovimiento() {
    const desc = $('desc').value; const monto = parseFloat($('monto').value);
    const cuenta_id = $('selCuenta').value; const activo_id = $('selActivo').value || null;
    if(!desc || !monto || !cuenta_id) return alert("Faltan datos");
    await fetch('/api/movimiento', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ descripcion:desc, monto, cuenta_id, activo_id, tipo:currentTipo }) });
    closeModal(); loadData();
}

async function crearCuenta() { const n = prompt("Nombre Cuenta:"); if(n) { await fetch('/api/cuentas', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})}); loadData(); }}
async function crearActivo() { const n = prompt("Nombre Proyecto:"); if(n) { await fetch('/api/activos', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})}); loadData(); }}

const fmtMoney = num => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(num);
function openModal(t) { currentTipo=t; $('modal').style.display='flex'; $('tipoTxt').value=t.toUpperCase(); $('desc').value=''; $('monto').value=''; }
function closeModal() { $('modal').style.display='none'; }
function populateSelects() {
    $('selCuenta').innerHTML = DATA.cuentas.map(c => `<option value="${c._id}">${c.nombre} ($${c.saldo})</option>`).join('');
    $('selActivo').innerHTML = `<option value="">-- Personal --</option>` + DATA.activos.map(a => `<option value="${a._id}">${a.nombre}</option>`).join('');
}
let chartRef;
function updateChart() {
    const ctx = $('chartActivos').getContext('2d'); if(chartRef) chartRef.destroy();
    const activos = DATA.activos.filter(a => a.balance_total > 0);
    chartRef = new Chart(ctx, { type:'doughnut', data:{ labels:activos.map(a=>a.nombre), datasets:[{data:activos.map(a=>a.balance_total), borderWidth:0, backgroundColor:['#00e676','#2979ff','#ff1744','#ffd700']}] }, options:{responsive:true, plugins:{legend:{position:'right', labels:{color:'#fff',boxWidth:10}}}} });
}
</script>
</body>
</html>
