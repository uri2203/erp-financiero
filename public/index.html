<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ERP CTRFAM | Gesti√≥n Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
    :root { --bg:#09090b; --card:#18181b; --text:#fafafa; --gray:#a1a1aa; --green:#22c55e; --red:#ef4444; --blue:#3b82f6; --yellow:#eab308; --border:#27272a; --cyan:#06b6d4; --purple:#8b5cf6; }
    body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; margin:0; padding:20px; height:100vh; box-sizing:border-box; display:flex; flex-direction:column; overflow:hidden; }
    
    /* MODALS */
    #login-overlay, #admin-overlay, #reporte-overlay, #proyecto-overlay, #traspaso-overlay, #modal, #arqueo-overlay, #cats-overlay { 
        position:fixed; top:0; left:0; width:100vw; height:100vh; 
        background:rgba(0,0,0,0.85); backdrop-filter:blur(5px); z-index:99999; 
        display:none; justify-content:center; align-items:center; 
    }
    
    .login-box { width:300px; text-align:center; }
    .admin-box, .reporte-box, .proyecto-box, .modal-box { width:95%; max-width:600px; max-height:90vh; background:#111; border:1px solid #333; border-radius:15px; padding:25px; display:flex; flex-direction:column; overflow-y:auto; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .reporte-box { max-width:900px; }
    
    .login-input { width:100%; padding:15px; background:#222; border:1px solid #333; color:#fff; margin-bottom:10px; border-radius:8px; font-size:16px; text-align:center; outline:none; transition:0.3s; }
    
    /* LAYOUT & CARDS */
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:var(--card); padding:15px; border-radius:12px; border:1px solid var(--border); }
    .grid { display:grid; grid-template-columns: 350px 1fr 400px; gap:20px; height:100%; overflow:hidden; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); }
    
    .card-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:15px; margin-bottom:15px; }
    h2 { font-size:14px; color:var(--gray); text-transform:uppercase; margin:0; letter-spacing:1px; font-weight:600; }
    .big-number { font-size:28px; font-weight:700; color:#fff; }
    
    /* BOTONES */
    .btn { border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; display:flex; justify-content:center; align-items:center; gap:8px; transition:0.2s; text-transform:uppercase; letter-spacing:0.5px; }
    .btn:hover { transform:translateY(-1px); filter:brightness(1.1); }
    .btn:active { transform:translateY(1px); }
    .btn-green { background:var(--green); color:#000; } 
    .btn-red { background:rgba(239, 68, 68, 0.15); color:var(--red); border:1px solid var(--red); }
    .btn-blue { background:rgba(59, 130, 246, 0.15); color:var(--blue); border:1px solid var(--blue); }
    .btn-cyan { background:var(--cyan); color:#000; }
    .btn-gold { background:var(--yellow); color:#000; }
    .btn-purple { background:var(--purple); color:#fff; }
    .btn-small { padding:6px 10px; font-size:11px; }
    
    /* OTROS */
    .editable-item { display:flex; justify-content:space-between; align-items:center; background:#222; padding:12px; border-radius:8px; margin-bottom:10px; border:1px solid #333; }
    .editable-actions { display:flex; gap:5px; opacity:0; transition:0.3s; }
    .editable-item:hover .editable-actions { opacity:1; }
    input, select { width:100%; padding:12px; background:#000; border:1px solid #333; color:#fff; border-radius:6px; margin-bottom:15px; box-sizing:border-box; outline:none; }
    .form-row { display:flex; gap:10px; }
    ul { list-style:none; padding:0; margin:0; overflow-y:auto; flex:1; }
    li { display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #222; align-items:center; }
    .meta-info { font-size:11px; color:#666; display:block; margin-top:4px; }

    /* PDF */
    #reporte-imprimible, #arqueo-imprimible { display: none; background: white; color: black; padding: 40px; font-family: 'Helvetica', sans-serif; }
    .pdf-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 20px; }
    .pdf-logo { font-size: 24px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; }
    .pdf-sub { font-size: 12px; color: #555; margin-top: 5px; }
    .pdf-table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .pdf-table th { background: #000; color: #fff; padding: 8px; text-align: left; }
    .pdf-table td { border-bottom: 1px solid #ddd; padding: 8px; }
    .ingreso-txt { color: #16a34a; font-weight: bold; }
    .gasto-txt { color: #dc2626; font-weight: bold; }
    .arqueo-total { font-size: 20px; font-weight: bold; text-align: right; margin-top: 20px; border-top: 2px solid #000; padding-top: 10px; }

    .checkbox-wrapper { display:flex; align-items:center; gap:10px; margin-bottom:15px; padding:10px; background:#222; border-radius:6px; }
    @media (max-width: 1200px) { .grid { grid-template-columns:1fr; grid-template-rows: auto auto auto; overflow-y:auto; } body { overflow-y:auto; height:auto; } }
</style>
</head>
<body>

<div id="reporte-imprimible">
    <div class="pdf-header"><div class="pdf-logo">ERP CTRFAM</div><div class="pdf-sub">Reporte Ejecutivo</div><div class="pdf-sub" id="pdf-fecha"></div><div class="pdf-sub" id="pdf-usuario"></div></div>
    <div style="display:flex;gap:20px;margin-bottom:30px;"><div style="flex:1;text-align:center;"><h3>Ingresos</h3><div class="val ingreso-txt" id="pdf-ing"></div></div><div style="flex:1;text-align:center;"><h3>Gastos</h3><div class="val gasto-txt" id="pdf-gas"></div></div><div style="flex:1;text-align:center;"><h3>Neto</h3><div class="val" id="pdf-net"></div></div></div>
    <h4 style="border-bottom:1px solid #000;">Detalle</h4>
    <table class="pdf-table"><thead><tr><th>Fecha</th><th>Desc</th><th>Categ</th><th>Monto</th></tr></thead><tbody id="pdf-tabla-body"></tbody></table>
</div>
<div id="arqueo-imprimible">
    <div class="pdf-header"><div class="pdf-logo">CORTE DE CAJA</div><div class="pdf-sub" id="arq-fecha"></div><div class="pdf-sub" id="arq-usuario"></div></div>
    <table class="pdf-table"><thead><tr><th>Cuenta</th><th style="text-align:right;">Saldo</th></tr></thead><tbody id="arq-tabla-body"></tbody></table>
    <div class="arqueo-total" id="arq-total">TOTAL: $0.00</div>
    <div style="margin-top:50px;text-align:center;border-top:1px dashed #000;width:200px;margin:0 auto;">Firma</div>
</div>

<div id="login-overlay" style="display:flex;">
    <div class="login-box">
        <div style="font-size:50px; margin-bottom:20px;">üõ°Ô∏è</div>
        <h2 style="border:none; color:#fff; margin-bottom:30px;">ACCESO SEGURO</h2>
        <input type="text" id="user" class="login-input" placeholder="Usuario">
        <input type="password" id="pass" class="login-input" placeholder="Contrase√±a">
        <button class="btn btn-green" style="width:100%; margin-top:20px;" onclick="doLogin()">ENTRAR</button>
        <p id="loginError" style="color:var(--red); font-size:12px; display:none; margin-top:10px;">Error</p>
    </div>
</div>

<div id="admin-overlay">
    <div class="admin-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 style="border:none; color:#fff;">‚öôÔ∏è Administraci√≥n</h2>
            <button class="btn btn-red btn-small" onclick="$('admin-overlay').style.display='none'">CERRAR</button>
        </div>
        
        <div style="background:#222; padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #333;">
            <h3 style="margin:0 0 10px 0; font-size:12px; color:var(--cyan);">CAJA FUERTE DE DATOS</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-blue" onclick="descargarBackup()" style="flex:1;">üíæ RESPALDAR TODO</button>
                <button class="btn btn-red" onclick="$('restoreInput').click()" style="flex:1;">‚ôªÔ∏è RESTAURAR</button>
                <input type="file" id="restoreInput" style="display:none;" onchange="restaurarBackup(this)">
            </div>
        </div>

        <div style="background:#222; padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid #333;">
            <h3 style="margin:0 0 15px 0; font-size:12px; color:var(--gray);" id="userModalTitle">GESTI√ìN PERSONAL</h3>
            <input type="hidden" id="userIdEdit"><input type="text" id="new_fullname" placeholder="Nombre"><input type="text" id="new_user" placeholder="Usuario"><input type="text" id="new_pass" placeholder="Pass">
            <div style="font-size:12px; margin:10px 0; color:#aaa;">Proyectos:</div><div id="checklistProyectos" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;"></div>
            <button class="btn btn-blue" style="width:100%" onclick="guardarUsuario()">GUARDAR</button>
        </div>
        
        <div style="margin-bottom:20px;"><button class="btn btn-purple" style="width:100%" onclick="abrirCats()">üè∑Ô∏è GESTIONAR CATEGOR√çAS</button></div>

        <div style="flex:1;"><h3 style="margin:0 0 10px 0; font-size:12px; color:var(--gray);">USUARIOS</h3><ul id="listaUsuarios"></ul></div>
    </div>
</div>

<div id="cats-overlay">
    <div class="modal-box">
        <h2 style="color:#fff;border:none;">Categor√≠as</h2>
        <div class="form-row">
            <input type="text" id="newCatName" placeholder="Nueva Categor√≠a">
            <select id="newCatType"><option value="gasto">Gasto</option><option value="ingreso">Ingreso</option></select>
        </div>
        <div style="margin-bottom:10px;">
            <label style="font-size:10px; color:#aaa;">Vincular a Proyecto (Opcional)</label>
            <select id="newCatProy"></select>
        </div>
        <button class="btn btn-green" onclick="crearCat()" style="width:100%;margin-bottom:15px;">AGREGAR</button>
        <ul id="listaCats" style="max-height:300px; overflow-y:auto;"></ul>
        <button class="btn btn-red" onclick="$('cats-overlay').style.display='none'" style="width:100%;margin-top:10px;">CERRAR</button>
    </div>
</div>

<div id="proyecto-overlay">
    <div class="proyecto-box">
        <h2 style="color:#fff;border:none;">Proyecto</h2><input type="hidden" id="proyIdEdit">
        <input type="text" id="proyNombre" placeholder="Nombre">
        <label style="color:var(--yellow);font-size:12px;margin:10px 0;display:block;">CUENTAS VINCULADAS</label>
        <div id="checklistCuentasProy" style="background:#222;padding:15px;border-radius:8px;display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:20px;"></div>
        <button class="btn btn-green" onclick="guardarActivoFull()">GUARDAR</button><button class="btn btn-red" style="margin-top:10px;" onclick="$('proyecto-overlay').style.display='none'">CANCELAR</button>
    </div>
</div>

<div id="traspaso-overlay">
    <div class="modal-box">
        <h2 style="color:#fff;border:none;">Traspaso</h2>
        <label style="font-size:12px;color:#aaa;">Monto</label><input type="number" id="trasMonto">
        <label style="font-size:12px;color:#aaa;">Origen</label><select id="trasOrigen"></select>
        <label style="font-size:12px;color:#aaa;">Destino</label><select id="trasDestino"></select>
        <label style="font-size:12px;color:#aaa;">Proyecto</label><select id="trasProyecto"></select>
        <label style="font-size:12px;color:#aaa;">Nota</label><input type="text" id="trasDesc">
        <button class="btn btn-cyan" onclick="ejecutarTraspaso()" style="margin-top:20px;">CONFIRMAR</button><button class="btn btn-red" onclick="$('traspaso-overlay').style.display='none'" style="margin-top:10px;">CANCELAR</button>
    </div>
</div>

<div id="arqueo-overlay">
    <div class="modal-box">
        <h2 style="color:#fff;border:none;">Corte de Caja</h2>
        <div id="listaArqueo" style="max-height:300px;overflow-y:auto;margin-bottom:20px;"></div>
        <div style="text-align:center;margin-bottom:20px;font-size:30px;font-weight:bold;color:var(--green);" id="totalArqueo">$0.00</div>
        <button class="btn btn-purple" onclick="guardarArqueoYPDF()">üíæ GUARDAR Y PDF</button><button class="btn btn-red" onclick="$('arqueo-overlay').style.display='none'" style="margin-top:10px;">CANCELAR</button>
    </div>
</div>

<div id="reporte-overlay">
    <div class="reporte-box">
        <div style="display:flex;justify-content:space-between;margin-bottom:20px;"><h2 style="border:none;margin:0;">üìä Reportes</h2><div><button class="btn btn-gold" onclick="descargarPDF()">üì• PDF</button><button class="btn btn-red" onclick="cerrarReportes()">X</button></div></div>
        <div class="filter-bar">
            <select id="filtroAnio" class="filter-select" onchange="actualizarReporte()"><option value="2026">2026</option><option value="2025">2025</option></select>
            <select id="filtroMes" class="filter-select" onchange="actualizarReporte()"><option value="todos">A√±o</option><option value="0">Ene</option><option value="1">Feb</option><option value="2">Mar</option><option value="3">Abr</option><option value="4">May</option><option value="5">Jun</option><option value="6">Jul</option><option value="7">Ago</option><option value="8">Sep</option><option value="9">Oct</option><option value="10">Nov</option><option value="11">Dic</option></select>
            <select id="filtroProyecto" class="filter-select" onchange="actualizarReporte()"><option value="todos">Todos</option></select>
        </div>
        <div style="display:flex;gap:20px;margin-bottom:20px;text-align:center;">
            <div style="flex:1;"><div style="color:var(--green);">INGRESOS</div><div id="repIng" style="font-size:20px;font-weight:bold;">$0</div></div>
            <div style="flex:1;"><div style="color:var(--red);">GASTOS</div><div id="repGas" style="font-size:20px;font-weight:bold;">$0</div></div>
            <div style="flex:1;"><div style="color:#fff;">NETO</div><div id="repNeto" style="font-size:20px;font-weight:bold;">$0</div></div>
        </div>
        <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px;">
            <div style="min-height:250px;"><canvas id="chartReporteMain"></canvas></div>
            <div style="min-height:250px;"><canvas id="chartReporteCat"></canvas></div>
        </div>
    </div>
</div>

<div id="modal">
    <div class="modal-box">
        <h2 id="modalTitle" style="color:var(--text);border:none;">Registro</h2>
        <label style="font-size:12px;color:#aaa;">Concepto</label><input type="text" id="desc">
        <div class="form-row"><div style="flex:1"><label style="font-size:12px;color:#aaa;">Monto</label><input type="number" id="monto"></div><div style="flex:1"><label style="font-size:12px;color:#aaa;">Tipo</label><input type="text" id="tipoTxt" readonly></div></div>
        
        <label style="font-size:12px;color:#aaa;">Proyecto</label><select id="selActivo" onchange="filtrarCategorias()"></select> <label style="font-size:12px;color:#aaa;">Categor√≠a</label>
        <select id="selCat"></select>

        <div id="divReembolso" class="checkbox-wrapper" style="display:none;"><input type="checkbox" id="chkReembolso"><label for="chkReembolso" style="color:var(--yellow);font-size:12px;">‚ö†Ô∏è Reembolso Pendiente</label></div>
        <label style="font-size:12px;color:#aaa;">Cuenta</label><select id="selCuenta"></select>
        
        <button class="btn btn-green" onclick="guardarMovimiento()" style="margin-top:20px;">CONFIRMAR</button><button class="btn btn-red" onclick="closeModal()" style="margin-top:10px;">CANCELAR</button>
    </div>
</div>

<div class="top-bar">
    <div><div style="font-size:11px;color:var(--gray);">PATRIMONIO</div><div class="big-number" id="totalPatrimonio">---</div></div>
    <div style="display:flex;gap:10px;">
        <button class="btn btn-cyan" onclick="abrirTraspaso()">‚áÑ TRASPASO</button>
        <button class="btn btn-gold" id="btnReportes" style="display:none;" onclick="abrirReportes()">üìä REPORTES</button>
        <button class="btn btn-blue" id="btnAdmin" style="display:none;" onclick="abrirAdmin()">‚öôÔ∏è</button>
        <button class="btn btn-green" onclick="openModal('ingreso')">‚¨Ü</button>
        <button class="btn btn-red" onclick="openModal('gasto')">‚¨á</button>
        <button class="btn" style="background:#333;color:#fff;" onclick="logout()">üîì</button>
    </div>
</div>
<div id="radar-alertas"></div>
<div class="grid">
    <div class="card"><div class="card-header"><h2>üè¶ Cuentas</h2><div style="display:flex;gap:5px;"><button class="btn btn-purple btn-small" onclick="abrirArqueo()">üßÆ CORTE</button><button class="btn btn-blue btn-small" id="btnAddCta" style="display:none;" onclick="crearCuenta()">+</button></div></div><div id="listCuentas"></div></div>
    <div class="card"><div class="card-header"><h2>üöÄ Proyectos</h2><button class="btn btn-blue btn-small" id="btnAddProy" style="display:none;" onclick="abrirModalProyecto()">+</button></div><div id="gridActivos"></div><div style="flex:1;padding-top:10px;"><canvas id="chartActivos"></canvas></div></div>
    <div class="card">
        <div class="card-header">
            <h2>üìù Movimientos</h2>
            <input type="text" id="searchMovs" placeholder="üîç Buscar..." style="width:120px;padding:5px;font-size:11px;" onkeyup="filtrarMovimientos()">
        </div>
        <ul id="listMovs"></ul>
    </div>
</div>

<script>
const $ = id => document.getElementById(id);
let DATA = { cuentas:[], activos:[], movimientos:[], pendientes:[], categorias:[] };
let CURRENT_USER = ''; let IS_ADMIN = false; let currentTipo = 'ingreso'; let chartRef, repChart1, repChart2; let REPORT_CACHE = null; let ALL_USERS=[];

async function doLogin() {
    const user=$('user').value, pass=$('pass').value;
    try { const r=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user,pass})}); const d=await r.json(); if(d.success){CURRENT_USER=d.user;IS_ADMIN=d.es_admin;$('login-overlay').style.display='none';loadData();}else{$('loginError').style.display='block';} }catch(e){alert("Error");}
}
function logout(){location.reload();}
async function loadData(){try{const r=await fetch(`/api/data?user=${CURRENT_USER}`); DATA=await r.json(); renderAll(); populateFilters();}catch(e){console.error(e);}}

function renderAll(){
    $('btnReportes').style.display='flex'; $('totalPatrimonio').innerText=fmtMoney(DATA.patrimonio);
    if(IS_ADMIN){$('btnAdmin').style.display='flex';$('btnAddProy').style.display='block';$('btnAddCta').style.display='block';}else{$('btnAdmin').style.display='none';$('btnAddProy').style.display='none';$('btnAddCta').style.display='none';}
    $('radar-alertas').innerHTML=DATA.pendientes.map(m=>`<div class="alerta-item"><div><strong>‚ö†Ô∏è REEMBOLSO: ${fmtMoney(Math.abs(m.monto))}</strong><br><span style="font-size:11px;">${m.descripcion}</span></div><button class="btn btn-green btn-small" onclick="confirmarReembolso('${m._id}')">‚úÖ</button></div>`).join('');
    if(DATA.pendientes.length>0)$('radar-alertas').style.display='flex';else $('radar-alertas').style.display='none';
    $('listCuentas').innerHTML=DATA.cuentas.map(c=>`<div class="editable-item"><div><span>${c.icono} ${c.nombre}</span> <span style="font-weight:bold;margin-left:10px;">${fmtMoney(c.saldo)}</span></div>${IS_ADMIN?`<div class="editable-actions"><button class="btn btn-blue btn-small" onclick="editarCuenta('${c._id}','${c.nombre}')">‚úèÔ∏è</button><button class="btn btn-red btn-small" onclick="borrarCuenta('${c._id}')">üóëÔ∏è</button></div>`:''}</div>`).join('');
    $('gridActivos').innerHTML=DATA.activos.map(a=>`<div class="editable-item" style="background:#151515;"><div style="flex:1;"><div style="font-size:11px;color:#888;">${a.icono} ${a.nombre}</div><div style="font-weight:bold;color:${a.balance_total>=0?'var(--green)':'var(--red)'}">${fmtMoney(a.balance_total)}</div></div>${IS_ADMIN?`<div class="editable-actions"><button class="btn btn-blue btn-small" onclick="abrirModalProyecto('${a._id}')">‚úèÔ∏è</button><button class="btn btn-red btn-small" onclick="borrarActivo('${a._id}')">üóëÔ∏è</button></div>`:''}</div>`).join('');
    renderMovs(DATA.movimientos);
    updateChart(); populateSelects();
}

function renderMovs(movs) {
    $('listMovs').innerHTML=movs.map(m=> { let c='var(--green)'; if(m.tipo==='gasto')c='var(--red)'; if(m.estado!=='finalizado')c='var(--yellow)'; if(m.tipo.includes('traspaso'))c='var(--cyan)'; return `<li style="opacity:${m.estado==='reembolsado'?0.5:1}"><div><span style="display:block;font-size:13px;font-weight:600;">${m.descripcion}</span><span class="meta-info">${m.categoria||'-'} | üë§${m.creado_por}</span></div><span style="font-weight:bold;color:${c}">${fmtMoney(m.monto)}</span></li>` }).join('');
}

// BUSCADOR UNIVERSAL
function filtrarMovimientos() {
    const q = $('searchMovs').value.toLowerCase();
    const filtrados = DATA.movimientos.filter(m => 
        m.descripcion.toLowerCase().includes(q) || 
        (m.categoria && m.categoria.toLowerCase().includes(q)) ||
        m.monto.toString().includes(q)
    );
    renderMovs(filtrados);
}

// CATEGORIAS INTELIGENTES
function abrirCats(){ $('cats-overlay').style.display='flex'; renderCats(); populateCatProjects(); }
function populateCatProjects() { $('newCatProy').innerHTML='<option value="">-- General (Todos) --</option>'+DATA.activos.map(a=>`<option value="${a._id}">${a.nombre}</option>`).join(''); }
function renderCats(){ $('listaCats').innerHTML=DATA.categorias.map(c=>`<li style="justify-content:space-between;"><span>${c.nombre} (${c.tipo}) <small style="color:#aaa">${c.proyecto_id ? '['+c.proyecto_id.nombre+']' : '[General]'}</small></span> <button class="btn btn-red btn-small" onclick="borrarCat('${c._id}')">X</button></li>`).join(''); }
async function crearCat(){ const n=$('newCatName').value, t=$('newCatType').value, p=$('newCatProy').value; if(n) await fetch('/api/categorias',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n, tipo:t, proyecto_id:p || null})}); $('newCatName').value=''; loadData().then(renderCats); }
async function borrarCat(id){ if(confirm("Borrar?")) await fetch(`/api/categorias/${id}`,{method:'DELETE'}); loadData().then(renderCats); }

function filtrarCategorias() {
    const projId = $('selActivo').value;
    const cats = DATA.categorias.filter(c => {
        // Mostrar si es del tipo correcto (gasto/ingreso) Y (es general O pertenece al proyecto seleccionado)
        return c.tipo === currentTipo && (!c.proyecto_id || c.proyecto_id._id === projId);
    });
    $('selCat').innerHTML = cats.length ? cats.map(c=>`<option value="${c.nombre}">${c.nombre}</option>`).join('') : '<option value="General">General</option>';
}

// BACKUP & RESTORE
async function descargarBackup() { const r=await fetch(`/api/backup?user=${CURRENT_USER}`); const d=await r.json(); const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=`Backup_ERP_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
async function restaurarBackup(input) { if(!confirm("‚ö†Ô∏è ESTO BORRAR√Å Y REEMPLAZAR√Å TODO. ¬øSEGURO?")) return; const f=input.files[0]; const reader=new FileReader(); reader.onload=async(e)=>{ try{ const data=JSON.parse(e.target.result); await fetch('/api/restore',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data, user:CURRENT_USER})}); alert("Restauraci√≥n Completa. Recargando..."); location.reload(); }catch(err){alert("Error en archivo");} }; reader.readAsText(f); }

// REPORTES & PDF
function abrirReportes(){$('reporte-overlay').style.display='flex';actualizarReporte();}
function cerrarReportes(){$('reporte-overlay').style.display='none';}
function populateFilters(){$('filtroProyecto').innerHTML='<option value="todos">Todos</option>'+DATA.activos.map(a=>`<option value="${a._id}">${a.nombre}</option>`).join('');}
async function actualizarReporte(){
    const anio=$('filtroAnio').value, mes=$('filtroMes').value, activo_id=$('filtroProyecto').value;
    const r=await fetch('/api/reporte',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({anio,mes,activo_id,user:CURRENT_USER})});
    const rep=await r.json(); REPORT_CACHE=rep;
    $('repIng').innerText=fmtMoney(rep.ingresos); $('repGas').innerText=fmtMoney(rep.gastos); $('repNeto').innerText=fmtMoney(rep.neto);
    const ctx1=$('chartReporteMain').getContext('2d'); if(repChart1)repChart1.destroy();
    repChart1=new Chart(ctx1,{type:'bar',data:{labels:['Ing','Gas','Neto'],datasets:[{data:[rep.ingresos,rep.gastos,rep.neto],backgroundColor:['#22c55e','#ef4444','#3b82f6']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{grid:{color:'#333'}}}}});
    const ctx2=$('chartReporteCat').getContext('2d'); if(repChart2)repChart2.destroy();
    const cats=Object.keys(rep.por_categoria||{}); const vals=Object.values(rep.por_categoria||{});
    repChart2=new Chart(ctx2,{type:'doughnut',data:{labels:cats,datasets:[{data:vals,backgroundColor:['#ef4444','#eab308','#3b82f6','#8b5cf6','#06b6d4','#22c55e'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#fff',boxWidth:10}}}}});
}
function descargarPDF(){
    if(!REPORT_CACHE)return; $('pdf-fecha').innerText="Fecha: "+new Date().toLocaleDateString(); $('pdf-usuario').innerText="Usuario: "+CURRENT_USER;
    $('pdf-ing').innerText=fmtMoney(REPORT_CACHE.ingresos); $('pdf-gas').innerText=fmtMoney(REPORT_CACHE.gastos); $('pdf-net').innerText=fmtMoney(REPORT_CACHE.neto);
    $('pdf-tabla-body').innerHTML=REPORT_CACHE.detalles.map(m=>`<tr><td>${new Date(m.fecha).toLocaleDateString()}</td><td>${m.descripcion}</td><td>${m.categoria||'-'}</td><td>${fmtMoney(Math.abs(m.monto))}</td></tr>`).join('');
    const e=$('reporte-imprimible'); e.style.display='block'; html2pdf().from(e).save().then(()=>{e.style.display='none';});
}

// GENERAL
function openModal(t){currentTipo=t;$('modal').style.display='flex';$('tipoTxt').value=t.toUpperCase();$('desc').value='';$('monto').value='';if(t==='gasto')$('divReembolso').style.display='flex';else $('divReembolso').style.display='none'; filtrarCategorias(); }
function closeModal(){$('modal').style.display='none';}
function populateSelects(){$('selCuenta').innerHTML=DATA.cuentas.map(c=>`<option value="${c._id}">${c.nombre} ($${c.saldo})</option>`).join('');$('selActivo').innerHTML=(IS_ADMIN?`<option value="">-- Personal --</option>`:'')+DATA.activos.map(a=>`<option value="${a._id}">${a.nombre}</option>`).join('');}
async function guardarMovimiento(){const d=$('desc').value,m=parseFloat($('monto').value),c=$('selCuenta').value,a=$('selActivo').value,r=$('chkReembolso').checked,cat=$('selCat').value;let s='finalizado';if(currentTipo==='gasto'&&r)s='pendiente_reembolso';if(!d||!m)return;await fetch('/api/movimiento',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({descripcion:d,monto:m,cuenta_id:c,activo_id:a,tipo:currentTipo,estado:s,categoria:cat,usuario_actual:CURRENT_USER})});closeModal();loadData();}
async function confirmarReembolso(id){if(!confirm("?"))return;await fetch('/api/confirmar-reembolso',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mov_id:id,usuario_actual:CURRENT_USER})});loadData();}

// ARQUEO
function abrirArqueo(){$('arqueo-overlay').style.display='flex';$('listaArqueo').innerHTML=DATA.cuentas.map(c=>`<div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #222;"><div style="display:flex;gap:10px;"><input type="checkbox" class="chk-arqueo" value="${c.saldo}" data-n="${c.nombre}" onchange="calcArq()"><span>${c.nombre}</span></div><span>${fmtMoney(c.saldo)}</span></div>`).join('');calcArq();}
function calcArq(){let t=0;document.querySelectorAll('.chk-arqueo:checked').forEach(k=>{t+=parseFloat(k.value)});$('totalArqueo').innerText=fmtMoney(t);}
async function guardarArqueoYPDF(){
    let t=0,d=[];document.querySelectorAll('.chk-arqueo:checked').forEach(k=>{const s=parseFloat(k.value);t+=s;d.push({cuenta:k.dataset.n,saldo:s});});if(!d.length)return;
    await fetch('/api/arqueo',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({usuario:CURRENT_USER,total:t,detalles:d})});
    $('arq-fecha').innerText=new Date().toLocaleString(); $('arq-usuario').innerText=CURRENT_USER; $('arq-total').innerText="TOTAL: "+fmtMoney(t); $('arq-tabla-body').innerHTML=d.map(x=>`<tr><td>${x.cuenta}</td><td style="text-align:right;">${fmtMoney(x.saldo)}</td></tr>`).join('');
    const e=$('arqueo-imprimible');e.style.display='block';html2pdf().from(e).save().then(()=>{e.style.display='none';$('arqueo-overlay').style.display='none';});
}

// ADMIN OTROS
function abrirTraspaso(){$('traspaso-overlay').style.display='flex';const o=DATA.cuentas.map(c=>`<option value="${c._id}">${c.nombre}</option>`).join('');$('trasOrigen').innerHTML=o;$('trasDestino').innerHTML=o;$('trasProyecto').innerHTML=DATA.activos.map(a=>`<option value="${a._id}">${a.nombre}</option>`).join('');}
async function ejecutarTraspaso(){const o=$('trasOrigen').value,d=$('trasDestino').value,m=$('trasMonto').value,desc=$('trasDesc').value,p=$('trasProyecto').value;if(o===d||!m)return;await fetch('/api/traspaso',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({origen_id:o,destino_id:d,monto:m,descripcion:desc,usuario_actual:CURRENT_USER,activo_id:p})});$('traspaso-overlay').style.display='none';loadData();}
async function abrirAdmin(){$('admin-overlay').style.display='flex';cargarUsuariosUI();}
async function cargarUsuariosUI(){const r=await fetch('/api/usuarios');ALL_USERS=await r.json();$('checklistProyectos').innerHTML=DATA.activos.map(a=>`<div style="display:flex;gap:5px;"><input type="checkbox" class="chk-proy" value="${a._id}" id="u_p_${a._id}"><span>${a.nombre}</span></div>`).join('');$('listaUsuarios').innerHTML=ALL_USERS.map(u=>`<li><div><strong>${u.user}</strong><br><small>${u.proyectos_permitidos.flatMap(p=>p.cuentas_asociadas?p.cuentas_asociadas.map(c=>c.nombre):[]).join(', ')}</small></div><button class="btn btn-blue btn-small" onclick="editarUsuario('${u._id}')">‚úèÔ∏è</button></li>`).join('');}
function editarUsuario(id){const u=ALL_USERS.find(x=>x._id===id);$('userIdEdit').value=id;$('new_user').value=u.user;$('new_fullname').value=u.nombre_completo;$('new_pass').value='';document.querySelectorAll('.chk-proy').forEach(c=>c.checked=false);if(u.proyectos_permitidos)u.proyectos_permitidos.forEach(p=>{const k=$( `u_p_${p._id}`);if(k)k.checked=true;});}
async function guardarUsuario(){const id=$('userIdEdit').value,u=$('new_user').value,p=$('new_pass').value,f=$('new_fullname').value,ps=Array.from(document.querySelectorAll('.chk-proy:checked')).map(c=>c.value);if(!u)return;const url=id?`/api/usuarios/${id}`:'/api/usuarios';const m=id?'PUT':'POST';await fetch(url,{method:m,headers:{'Content-Type':'application/json'},body:JSON.stringify({user:u,pass:p,nombre_completo:f,proyectos:ps})});cargarUsuariosUI();}
async function crearCuenta(){const n=prompt("Nombre:");if(n)await fetch('/api/cuentas',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})});loadData();}
async function editarCuenta(id,o){const n=prompt("Nombre:",o);if(n)await fetch(`/api/cuentas/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})});loadData();}
async function borrarCuenta(id){if(confirm("X"))await fetch(`/api/cuentas/${id}`,{method:'DELETE'});loadData();}
function abrirModalProyecto(id=null){$('proyecto-overlay').style.display='flex';$('proyIdEdit').value=id||'';$('checklistCuentasProy').innerHTML=DATA.cuentas.map(c=>`<div style="display:flex;gap:10px;"><input type="checkbox" class="chk-cta-proy" value="${c._id}" id="cp_${c._id}"><label for="cp_${c._id}" style="color:#fff;">${c.nombre}</label></div>`).join('');if(id){const p=DATA.activos.find(a=>a._id===id);$('proyNombre').value=p.nombre;if(p.cuentas_asociadas)p.cuentas_asociadas.forEach(c=>{const k=$(`cp_${c._id}`);if(k)k.checked=true;});}else{$('proyNombre').value='';}}
async function guardarActivoFull(){const id=$('proyIdEdit').value,n=$('proyNombre').value,cs=Array.from(document.querySelectorAll('.chk-cta-proy:checked')).map(c=>c.value);if(!n)return;const u=id?`/api/activos/${id}`:'/api/activos';const m=id?'PUT':'POST';await fetch(u,{method:m,headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n,cuentas:cs})});$('proyecto-overlay').style.display='none';loadData();}
async function borrarActivo(id){if(confirm("X"))await fetch(`/api/activos/${id}`,{method:'DELETE'});loadData();}
function updateChart(){const ctx=$('chartActivos').getContext('2d');if(chartRef)chartRef.destroy();const ac=DATA.activos.filter(a=>a.balance_total>0);chartRef=new Chart(ctx,{type:'doughnut',data:{labels:ac.map(a=>a.nombre),datasets:[{data:ac.map(a=>a.balance_total),borderWidth:0,backgroundColor:['#22c55e','#3b82f6','#ef4444','#eab308']}]},options:{responsive:true,plugins:{legend:{position:'right',labels:{color:'#fff',boxWidth:10}}}}});}
const fmtMoney=n=>new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(n);
</script>
</body>
</html>
