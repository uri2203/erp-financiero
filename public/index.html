<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ERP CTRFAM | Gesti√≥n Integral</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root { --bg:#050505; --card:#111; --text:#fff; --gray:#888; --green:#00e676; --red:#ff1744; --blue:#2979ff; --yellow:#ffd700; --border:#222; }
    body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; margin:0; padding:20px; height:100vh; box-sizing:border-box; display:flex; flex-direction:column; overflow:hidden; }
    
    /* MODALS */
    #login-overlay, #admin-overlay, #reporte-overlay, #proyecto-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    #admin-overlay, #reporte-overlay, #proyecto-overlay { background:rgba(0,0,0,0.95); z-index:9998; display:none; }
    
    .login-box { width:300px; text-align:center; }
    .admin-box, .reporte-box, .proyecto-box { width:90%; max-width:600px; height:80vh; background:#111; border:1px solid #333; border-radius:15px; padding:20px; display:flex; flex-direction:column; overflow-y:auto; }
    .reporte-box { max-width:800px; }
    .proyecto-box { height:auto; max-height:80vh; }
    .login-input { width:100%; padding:15px; background:#111; border:1px solid #333; color:#fff; margin-bottom:10px; border-radius:8px; font-size:16px; text-align:center; }
    
    /* RADAR ALERTAS */
    #radar-alertas { display:none; flex-direction:column; gap:10px; margin-bottom:20px; }
    .alerta-item { background:rgba(255, 215, 0, 0.1); border:1px solid var(--yellow); padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; color:var(--yellow); }
    
    /* LAYOUT & CARDS */
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .grid { display:grid; grid-template-columns: 300px 1fr 350px; gap:20px; height:100%; overflow:hidden; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:15px; display:flex; flex-direction:column; overflow:hidden; }
    .card-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:10px; margin-bottom:15px; }
    h2 { font-size:14px; color:var(--gray); text-transform:uppercase; margin:0; }
    .big-number { font-size:32px; font-weight:800; letter-spacing:-1px; }
    ul { list-style:none; padding:0; margin:0; overflow-y:auto; flex:1; }
    li { display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #222; }
    .meta-info { font-size:10px; color:#555; display:block; margin-top:2px; }
    
    .btn { border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:700; font-size:12px; display:flex; justify-content:center; align-items:center; gap:8px; transition:0.2s; }
    .btn:hover { opacity:0.8; }
    .btn-green { background:var(--green); color:#000; } 
    .btn-red { background:rgba(255,23,68,0.15); color:var(--red); border:1px solid var(--red); }
    .btn-blue { background:rgba(41,121,255,0.15); color:var(--blue); border:1px solid var(--blue); }
    .btn-gold { background:rgba(255, 215, 0, 0.15); color:#ffd700; border:1px solid #ffd700; }
    .btn-small { padding:5px; width:auto; font-size:10px; }
    
    /* EDITABLES & FILTERS */
    .editable-item { display:flex; justify-content:space-between; align-items:center; background:#1a1a1a; padding:10px; border-radius:8px; margin-bottom:8px; }
    .editable-actions { display:flex; gap:5px; opacity:0.3; transition:0.3s; }
    .editable-item:hover .editable-actions { opacity:1; }
    .filter-bar { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
    .filter-select { background:#000; color:#fff; border:1px solid #333; padding:10px; border-radius:6px; flex:1; }

    /* MODAL REGISTRO */
    #modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99; display:none; justify-content:center; align-items:center; backdrop-filter:blur(5px); }
    .modal-box { background:#151515; border:1px solid #333; width:400px; padding:25px; border-radius:12px; }
    input, select { width:100%; padding:12px; background:#000; border:1px solid #333; color:#fff; border-radius:6px; margin-bottom:15px; box-sizing:border-box; }
    .form-row { display:flex; gap:10px; }
    .checkbox-wrapper { display:flex; align-items:center; gap:10px; margin-bottom:15px; padding:10px; background:#222; border-radius:6px; }
    
    @media (max-width: 1000px) { .grid { grid-template-columns:1fr; grid-template-rows: auto auto auto; overflow-y:auto; } body { overflow-y:auto; height:auto; } }
</style>
</head>
<body>

<div id="login-overlay">
    <div style="font-size:40px; margin-bottom:20px;">üõ°Ô∏è</div>
    <div class="login-box">
        <h2 style="border:none; color:#fff;">ERP CTRFAM</h2>
        <input type="text" id="user" class="login-input" placeholder="Usuario">
        <input type="password" id="pass" class="login-input" placeholder="Contrase√±a">
        <button class="btn btn-green" style="width:100%" onclick="doLogin()">ACCEDER</button>
        <p id="loginError" style="color:var(--red); font-size:12px; display:none;">Acceso Denegado</p>
    </div>
</div>

<div id="admin-overlay">
    <div class="admin-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 style="border:none; color:#fff; margin:0;">üë• Gesti√≥n de Personal</h2>
            <button class="btn btn-red" style="width:auto; padding:5px 15px;" onclick="$('admin-overlay').style.display='none'">CERRAR</button>
        </div>
        <div style="background:#222; padding:15px; border-radius:8px; margin-bottom:20px;">
            <h3 style="margin:0 0 10px 0; font-size:12px; color:var(--gray);">NUEVO COLABORADOR</h3>
            <input type="text" id="new_fullname" placeholder="Nombre Completo">
            <input type="text" id="new_user" placeholder="Usuario">
            <input type="text" id="new_pass" placeholder="Contrase√±a">
            <div style="font-size:12px; margin-bottom:5px; color:#aaa;">Proyectos Permitidos:</div>
            <div id="checklistProyectos" style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-bottom:10px;"></div>
            <button class="btn btn-blue" onclick="guardarUsuario()">GUARDAR USUARIO</button>
        </div>
        <div style="flex:1; overflow-y:auto;">
            <h3 style="margin:0 0 10px 0; font-size:12px; color:var(--gray);">EQUIPO ACTUAL</h3>
            <ul id="listaUsuarios"></ul>
        </div>
    </div>
</div>

<div id="proyecto-overlay">
    <div class="proyecto-box">
        <h2 style="color:#fff; border:none; margin-bottom:20px;" id="proyModalTitle">Configurar Proyecto</h2>
        <input type="hidden" id="proyIdEdit"> <label>Nombre del Proyecto</label>
        <input type="text" id="proyNombre" placeholder="Ej. Yayika ML">
        
        <label style="color:var(--yellow); font-size:12px;">CUENTAS VINCULADAS (Solo estas cuentas ser√°n visibles para los empleados asignados a este proyecto)</label>
        <div id="checklistCuentasProy" style="background:#222; padding:10px; border-radius:8px; display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-bottom:20px;">
            </div>

        <div class="form-row">
            <button class="btn btn-green" onclick="guardarActivoFull()">GUARDAR</button>
            <button class="btn btn-red" onclick="$('proyecto-overlay').style.display='none'">CANCELAR</button>
        </div>
    </div>
</div>

<div id="reporte-overlay">
    <div class="reporte-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="border:none; margin:0; font-size:20px; color:#fff;">üìä Reportes</h2>
            <button class="btn btn-red" style="width:auto; padding:5px 15px;" onclick="cerrarReportes()">X CERRAR</button>
        </div>
        <div class="filter-bar">
            <select id="filtroAnio" class="filter-select" onchange="actualizarReporte()"><option value="2026">2026</option><option value="2025">2025</option></select>
            <select id="filtroMes" class="filter-select" onchange="actualizarReporte()">
                <option value="todos">Todo el A√±o</option><option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option><option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option><option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option><option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
            </select>
            <select id="filtroProyecto" class="filter-select" onchange="actualizarReporte()"><option value="todos">Todos los Proyectos</option></select>
        </div>
        <div style="flex:1; position:relative;"><canvas id="chartReporteMain"></canvas></div>
        <div style="display:flex; gap:20px; margin-top:20px; border-top:1px solid #333; padding-top:15px;">
            <div style="text-align:center; flex:1;"><div style="color:var(--green); font-weight:bold;">INGRESOS</div><div id="repIng" style="font-size:20px;">$0.00</div></div>
            <div style="text-align:center; flex:1;"><div style="color:var(--red); font-weight:bold;">GASTOS</div><div id="repGas" style="font-size:20px;">$0.00</div></div>
            <div style="text-align:center; flex:1;"><div style="color:#fff; font-weight:bold;">NETO</div><div id="repNeto" style="font-size:20px;">$0.00</div></div>
        </div>
    </div>
</div>

<div class="top-bar">
    <div>
        <div style="font-size:12px; color:var(--gray); font-weight:600;">PATRIMONIO VISIBLE</div>
        <div class="big-number" id="totalPatrimonio">---</div>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="btn btn-gold" id="btnReportes" style="display:none; width:auto; padding:10px 20px;" onclick="abrirReportes()">üìä REPORTES</button>
        <button class="btn btn-blue" id="btnAdmin" style="display:none; width:auto; padding:10px 20px;" onclick="abrirAdmin()">‚öôÔ∏è PERSONAL</button>
        <button class="btn btn-green" style="width:auto; padding:10px 20px;" onclick="openModal('ingreso')">‚¨Ü INGRESAR</button>
        <button class="btn btn-red" style="width:auto; padding:10px 20px;" onclick="openModal('gasto')">‚¨á GASTAR</button>
        <button class="btn" style="width:auto; background:#333; color:#fff;" onclick="logout()">üîì SALIR</button>
    </div>
</div>

<div id="radar-alertas"></div>

<div class="grid">
    <div class="card">
        <div class="card-header"><h2>üè¶ Cuentas Visibles</h2><button class="btn btn-blue btn-small" id="btnAddCta" style="display:none;" onclick="crearCuenta()">+ AGREGAR</button></div>
        <div id="listCuentas"></div>
    </div>
    <div class="card">
        <div class="card-header"><h2>üöÄ Proyectos</h2><button class="btn btn-blue btn-small" id="btnAddProy" style="display:none;" onclick="abrirModalProyecto()">+ AGREGAR</button></div>
        <div style="display:grid; grid-template-columns:1fr; gap:5px; margin-bottom:15px;" id="gridActivos"></div>
        <div style="flex:1; border-top:1px solid #222; padding-top:10px;"><canvas id="chartActivos"></canvas></div>
    </div>
    <div class="card">
        <div class="card-header"><h2>üìù Auditor√≠a</h2></div>
        <ul id="listMovs"></ul>
    </div>
</div>

<div id="modal">
    <div class="modal-box">
        <h2 id="modalTitle" style="color:var(--text); border:none;">Registrar</h2>
        <label>Descripci√≥n</label><input type="text" id="desc">
        <div class="form-row">
            <div style="flex:1"><label>Monto ($)</label><input type="number" id="monto"></div>
            <div style="flex:1"><label>Tipo</label><input type="text" id="tipoTxt" readonly style="color:#888;"></div>
        </div>
        <div id="divReembolso" class="checkbox-wrapper" style="display:none;">
            <input type="checkbox" id="chkReembolso" style="width:auto; margin:0;">
            <label for="chkReembolso" style="color:var(--yellow); font-size:12px; margin:0;">‚ö†Ô∏è Marcar como "Esperando Reembolso"</label>
        </div>
        <label>Cuenta</label><select id="selCuenta"></select>
        <label>Proyecto</label><select id="selActivo"></select>
        <div class="form-row" style="margin-top:20px;">
            <button class="btn btn-green" onclick="guardarMovimiento()">GUARDAR</button>
            <button class="btn btn-red" onclick="closeModal()">CANCELAR</button>
        </div>
    </div>
</div>

<script>
const $ = id => document.getElementById(id);
let DATA = { cuentas:[], activos:[], movimientos:[], pendientes:[] };
let CURRENT_USER = '';
let IS_ADMIN = false;
let currentTipo = 'ingreso';
let chartRef, reportChartRef;

// --- LOGIN ---
async function doLogin() {
    const user = $('user').value; const pass = $('pass').value;
    try {
        const res = await fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user,pass})});
        const data = await res.json();
        if (data.success) { CURRENT_USER = data.user; IS_ADMIN = data.es_admin; $('login-overlay').style.display='none'; loadData(); } 
        else { $('loginError').style.display='block'; }
    } catch(e) { alert("Error Conexi√≥n"); }
}
function logout() { location.reload(); }

// --- DATA & RENDER ---
async function loadData() {
    try {
        const res = await fetch(`/api/data?user=${CURRENT_USER}`); DATA = await res.json(); renderAll(); populateFilters();
    } catch(e) { console.error("Error cargando"); }
}

function renderAll() {
    if(IS_ADMIN) {
        $('btnAdmin').style.display = 'flex'; $('btnReportes').style.display = 'flex';
        $('btnAddProy').style.display = 'block'; $('btnAddCta').style.display = 'block';
        $('totalPatrimonio').innerText = fmtMoney(DATA.patrimonio);
    } else {
        $('totalPatrimonio').innerText = 'üîí Oculto';
    }

    const radar = $('radar-alertas'); radar.innerHTML = '';
    if(DATA.pendientes && DATA.pendientes.length > 0) {
        radar.style.display = 'flex';
        DATA.pendientes.forEach(m => {
            const item = document.createElement('div'); item.className = 'alerta-item';
            item.innerHTML = `<div><strong>‚ö†Ô∏è REEMBOLSO PENDIENTE: ${fmtMoney(Math.abs(m.monto))}</strong><br><span style="font-size:11px;">${m.descripcion} (${m.activo_id?.nombre})</span></div><button class="btn btn-green" style="padding:5px 10px; width:auto;" onclick="confirmarReembolso('${m._id}')">‚úÖ CONFIRMAR</button>`;
            radar.appendChild(item);
        });
    } else { radar.style.display = 'none'; }

    $('listCuentas').innerHTML = DATA.cuentas.map(c => `
        <div class="editable-item">
            <div><span>${c.icono} ${c.nombre}</span> <span style="font-weight:bold; margin-left:10px;">${fmtMoney(c.saldo)}</span></div>
            ${IS_ADMIN ? `<div class="editable-actions"><button class="btn btn-blue btn-small" onclick="editarCuenta('${c._id}','${c.nombre}')">‚úèÔ∏è</button><button class="btn btn-red btn-small" onclick="borrarCuenta('${c._id}')">üóëÔ∏è</button></div>` : ''}
        </div>`).join('');
    
    // Proyectos (Muestra detalles de cuentas vinculadas al editar)
    $('gridActivos').innerHTML = DATA.activos.map(a => `
        <div class="editable-item" style="background:#151515; border:1px solid #333;">
            <div style="flex:1;">
                <div style="font-size:11px; color:#888;">${a.icono} ${a.nombre}</div>
                <div style="font-size:15px; font-weight:bold; color:${a.balance_total>=0?'var(--green)':'var(--red)'}">${fmtMoney(a.balance_total)}</div>
                ${IS_ADMIN && a.cuentas_asociadas ? `<div style="font-size:9px; color:#555;">Cuentas: ${a.cuentas_asociadas.map(c=>c.nombre).join(', ')}</div>` : ''}
            </div>
            ${IS_ADMIN ? `<div class="editable-actions"><button class="btn btn-blue btn-small" onclick="abrirModalProyecto('${a._id}')">‚úèÔ∏è</button><button class="btn btn-red btn-small" onclick="borrarActivo('${a._id}')">üóëÔ∏è</button></div>` : ''}
        </div>`).join('');
    
    $('listMovs').innerHTML = DATA.movimientos.map(m => {
        let color = m.tipo=='ingreso'?'var(--green)':'var(--red)';
        if(m.estado === 'pendiente_reembolso') color = 'var(--yellow)'; if(m.estado === 'reembolsado') color = '#555';
        return `<li style="opacity:${m.estado==='reembolsado'?0.5:1}"><div><span style="display:block; font-size:13px; font-weight:600;">${m.descripcion} ${m.estado==='reembolsado'?'(DEVUELTO)':''}</span><span class="meta-info">üë§ ${m.creado_por} | üìÇ ${m.activo_id?m.activo_id.nombre:'General'}</span></div><span style="font-weight:bold; color:${color}">${m.tipo=='ingreso'?'+':''}${fmtMoney(m.monto)}</span></li>`
    }).join('');
    
    updateChart(); populateSelects();
}

// --- LOGICA PROYECTOS AVANZADA ---
function abrirModalProyecto(id = null) {
    $('proyecto-overlay').style.display='flex';
    $('proyIdEdit').value = id || '';
    
    // Cargar Cuentas para el checklist
    // OJO: Mostramos TODAS las cuentas disponibles para que el admin elija
    // Usamos fetch directo a cuentas o usamos DATA.cuentas si ya somos admin (Admin tiene todas en DATA)
    const container = $('checklistCuentasProy');
    container.innerHTML = DATA.cuentas.map(c => `
        <div style="display:flex; align-items:center; gap:5px;">
            <input type="checkbox" class="chk-cta-proy" value="${c._id}" id="chk_cta_${c._id}"> 
            <label for="chk_cta_${c._id}" style="font-size:12px; cursor:pointer;">${c.nombre}</label>
        </div>
    `).join('');

    if(id) {
        // Modo Edici√≥n: Cargar datos actuales
        const proy = DATA.activos.find(a => a._id === id);
        $('proyModalTitle').innerText = "Editar Proyecto";
        $('proyNombre').value = proy.nombre;
        // Marcar cuentas ya asociadas
        if(proy.cuentas_asociadas) {
            proy.cuentas_asociadas.forEach(c => {
                const chk = document.getElementById(`chk_cta_${c._id}`);
                if(chk) chk.checked = true;
            });
        }
    } else {
        $('proyModalTitle').innerText = "Nuevo Proyecto";
        $('proyNombre').value = '';
    }
}

async function guardarActivoFull() {
    const id = $('proyIdEdit').value;
    const nombre = $('proyNombre').value;
    const checks = document.querySelectorAll('.chk-cta-proy:checked');
    const cuentas = Array.from(checks).map(c => c.value);

    if(!nombre) return alert("Nombre obligatorio");

    const url = id ? `/api/activos/${id}` : '/api/activos';
    const method = id ? 'PUT' : 'POST';

    await fetch(url, { method, headers:{'Content-Type':'application/json'}, body:JSON.stringify({nombre, cuentas})});
    $('proyecto-overlay').style.display='none';
    loadData();
}

async function borrarActivo(id) { if(confirm("¬øEliminar proyecto?")) { await fetch(`/api/activos/${id}`, {method:'DELETE'}); loadData(); }}

// --- CRUD CUENTAS ---
async function crearCuenta() { const n = prompt("Nombre Cuenta:"); if(n) { await fetch('/api/cuentas', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})}); loadData(); }}
async function editarCuenta(id, nOld) { const n = prompt("Nuevo nombre:", nOld); if(n) { await fetch(`/api/cuentas/${id}`, {method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})}); loadData(); }}
async function borrarCuenta(id) { if(confirm("¬øEliminar cuenta?")) { await fetch(`/api/cuentas/${id}`, {method:'DELETE'}); loadData(); }}

// --- OTROS (Sin cambios importantes) ---
async function abrirAdmin() { $('admin-overlay').style.display='flex'; cargarUsuariosUI(); }
async function cargarUsuariosUI() {
    const res = await fetch('/api/usuarios'); const users = await res.json();
    $('checklistProyectos').innerHTML = DATA.activos.map(a => `<div style="display:flex; align-items:center; gap:5px;"><input type="checkbox" class="chk-proy" value="${a._id}"> <span style="font-size:12px; color:#aaa;">${a.nombre}</span></div>`).join('');
    $('listaUsuarios').innerHTML = users.map(u => `<li style="display:flex; justify-content:space-between; align-items:center;"><div><strong style="color:${u.es_admin?'var(--green)':'#fff'}">${u.nombre_completo||u.user}</strong><div style="font-size:10px; color:#aaa;">${u.user} | ${u.es_admin?'ADMIN':(u.proyectos_permitidos.map(p=>p.nombre).join(', ')||'Sin acceso')}</div></div>${!u.es_admin ? `<button class="btn btn-red" style="padding:5px;" onclick="borrarUsuario('${u._id}')">üóëÔ∏è</button>` : ''}</li>`).join('');
}
async function guardarUsuario() {
    const fullname=$('new_fullname').value; const user=$('new_user').value; const pass=$('new_pass').value;
    const checks=document.querySelectorAll('.chk-proy:checked'); const proys=Array.from(checks).map(c=>c.value);
    if(!user||!pass) return alert("Faltan datos");
    await fetch('/api/usuarios', { method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'crear',user,pass,nombre_completo:fullname,proyectos:proys})});
    $('new_fullname').value=''; $('new_user').value=''; $('new_pass').value=''; cargarUsuariosUI();
}
async function borrarUsuario(id) { if(confirm("Eliminar?")) { await fetch('/api/usuarios', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'borrar',id})}); cargarUsuariosUI(); } }

async function guardarMovimiento() {
    const desc = $('desc').value; const monto = parseFloat($('monto').value); const cuenta_id = $('selCuenta').value; const activo_id = $('selActivo').value || null; const esReembolso = $('chkReembolso').checked;
    let estado = 'finalizado'; if(currentTipo === 'gasto' && esReembolso) estado = 'pendiente_reembolso';
    if(!desc || !monto || !cuenta_id) return alert("Faltan datos");
    const res = await fetch('/api/movimiento', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ descripcion:desc, monto, cuenta_id, activo_id, tipo:currentTipo, estado, usuario_actual: CURRENT_USER }) });
    const json = await res.json(); if(json.error) return alert(json.error); closeModal(); loadData();
}
async function confirmarReembolso(id) { if(!confirm("Confirmar recepci√≥n?")) return; await fetch('/api/confirmar-reembolso', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ mov_id: id, usuario_actual: CURRENT_USER }) }); loadData(); }
function abrirReportes() { $('reporte-overlay').style.display = 'flex'; actualizarReporte(); }
function cerrarReportes() { $('reporte-overlay').style.display = 'none'; }
function populateFilters() { $('filtroProyecto').innerHTML = '<option value="todos">Todos los Proyectos</option>' + DATA.activos.map(a => `<option value="${a._id}">${a.nombre}</option>`).join(''); }
async function actualizarReporte() {
    const anio = $('filtroAnio').value; const mes = $('filtroMes').value; const activo_id = $('filtroProyecto').value;
    const res = await fetch('/api/reporte', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ anio, mes, activo_id }) });
    const reporte = await res.json();
    $('repIng').innerText = fmtMoney(reporte.ingresos); $('repGas').innerText = fmtMoney(reporte.gastos); $('repNeto').innerText = fmtMoney(reporte.neto); $('repNeto').style.color = reporte.neto >= 0 ? 'var(--green)' : 'var(--red)';
    const ctx = $('chartReporteMain').getContext('2d'); if(reportChartRef) reportChartRef.destroy();
    reportChartRef = new Chart(ctx, { type: 'bar', data: { labels: ['Ingresos', 'Gastos', 'Neto'], datasets: [{ label: 'Flujo', data: [reporte.ingresos, reporte.gastos, reporte.neto], backgroundColor: ['#00e676', '#ff1744', '#2979ff'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#333' }, ticks: { color: '#888' } } } } });
}
const fmtMoney = num => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(num);
function openModal(t) { currentTipo=t; $('modal').style.display='flex'; $('tipoTxt').value=t.toUpperCase(); $('desc').value=''; $('monto').value=''; if(t === 'gasto') $('divReembolso').style.display = 'flex'; else $('divReembolso').style.display = 'none'; $('chkReembolso').checked = false; }
function closeModal() { $('modal').style.display='none'; }
function populateSelects() { $('selCuenta').innerHTML = DATA.cuentas.map(c => `<option value="${c._id}">${c.nombre} ($${c.saldo})</option>`).join(''); $('selActivo').innerHTML = (IS_ADMIN ? `<option value="">-- Personal --</option>` : '') + DATA.activos.map(a => `<option value="${a._id}">${a.nombre}</option>`).join(''); }
function updateChart() { const ctx = $('chartActivos').getContext('2d'); if(chartRef) chartRef.destroy(); const activos = DATA.activos.filter(a => a.balance_total > 0); chartRef = new Chart(ctx, { type:'doughnut', data:{ labels:activos.map(a=>a.nombre), datasets:[{data:activos.map(a=>a.balance_total), borderWidth:0, backgroundColor:['#00e676','#2979ff','#ff1744','#ffd700']}] }, options:{responsive:true, plugins:{legend:{position:'right', labels:{color:'#fff',boxWidth:10}}}} }); }
</script>
</body>
</html>
