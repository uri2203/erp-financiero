<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ERP Empresarial | Control Total</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root { --bg:#050505; --card:#111; --text:#fff; --gray:#888; --green:#00e676; --red:#ff1744; --blue:#2979ff; --yellow:#ffd700; --border:#222; }
    body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; margin:0; padding:20px; height:100vh; box-sizing:border-box; display:flex; flex-direction:column; overflow:hidden; }
    
    /* MODALS */
    #login-overlay, #admin-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    #admin-overlay { background:rgba(0,0,0,0.95); z-index:9998; display:none; }
    
    .login-box { width:300px; text-align:center; }
    .admin-box { width:90%; max-width:600px; height:80vh; background:#111; border:1px solid #333; border-radius:15px; padding:20px; display:flex; flex-direction:column; overflow-y:auto; }
    .login-input { width:100%; padding:15px; background:#111; border:1px solid #333; color:#fff; margin-bottom:10px; border-radius:8px; font-size:16px; text-align:center; }
    
    /* RADAR ALERTAS */
    #radar-alertas { display:none; flex-direction:column; gap:10px; margin-bottom:20px; }
    .alerta-item { background:rgba(255, 215, 0, 0.1); border:1px solid var(--yellow); padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; color:var(--yellow); }
    
    /* LAYOUT */
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .grid { display:grid; grid-template-columns: 300px 1fr 350px; gap:20px; height:100%; overflow:hidden; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:15px; display:flex; flex-direction:column; overflow:hidden; }
    h2 { font-size:14px; color:var(--gray); text-transform:uppercase; margin:0 0 15px 0; border-bottom:1px solid var(--border); padding-bottom:10px; }
    .big-number { font-size:32px; font-weight:800; letter-spacing:-1px; }
    ul { list-style:none; padding:0; margin:0; overflow-y:auto; flex:1; }
    li { display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #222; }
    .meta-info { font-size:10px; color:#555; display:block; margin-top:2px; }
    
    .btn { border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:700; font-size:12px; display:flex; justify-content:center; align-items:center; gap:8px; transition:0.2s; }
    .btn:hover { opacity:0.8; }
    .btn-green { background:var(--green); color:#000; } 
    .btn-red { background:rgba(255,23,68,0.15); color:var(--red); border:1px solid var(--red); }
    .btn-blue { background:rgba(41,121,255,0.15); color:var(--blue); border:1px solid var(--blue); }
    .btn-yellow { background:var(--yellow); color:#000; }

    /* MODAL REGISTRO */
    #modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99; display:none; justify-content:center; align-items:center; backdrop-filter:blur(5px); }
    .modal-box { background:#151515; border:1px solid #333; width:400px; padding:25px; border-radius:12px; }
    input, select { width:100%; padding:12px; background:#000; border:1px solid #333; color:#fff; border-radius:6px; margin-bottom:15px; box-sizing:border-box; }
    .form-row { display:flex; gap:10px; }
    .checkbox-wrapper { display:flex; align-items:center; gap:10px; margin-bottom:15px; padding:10px; background:#222; border-radius:6px; }
    
    @media (max-width: 1000px) { .grid { grid-template-columns:1fr; grid-template-rows: auto auto auto; overflow-y:auto; } body { overflow-y:auto; height:auto; } }
</style>
</head>
<body>

<div id="login-overlay">
    <div style="font-size:40px; margin-bottom:20px;">üõ°Ô∏è</div>
    <div class="login-box">
        <h2 style="border:none; color:#fff;">ERP CORPORATIVO</h2>
        <input type="text" id="user" class="login-input" placeholder="Usuario">
        <input type="password" id="pass" class="login-input" placeholder="Contrase√±a">
        <button class="btn btn-green" style="width:100%" onclick="doLogin()">ACCEDER</button>
        <p id="loginError" style="color:var(--red); font-size:12px; display:none;">Acceso Denegado</p>
    </div>
</div>

<div id="admin-overlay">
    <div class="admin-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 style="border:none; color:#fff; margin:0;">üë• Gesti√≥n de Personal</h2>
            <button class="btn btn-red" style="width:auto; padding:5px 15px;" onclick="$('admin-overlay').style.display='none'">CERRAR</button>
        </div>
        <div style="background:#222; padding:15px; border-radius:8px; margin-bottom:20px;">
            <h3 style="margin:0 0 10px 0; font-size:12px; color:var(--gray);">CREAR / EDITAR USUARIO</h3>
            <input type="text" id="new_user" placeholder="Nombre Usuario (Ej. Juan)">
            <input type="text" id="new_pass" placeholder="Contrase√±a">
            <div style="font-size:12px; margin-bottom:5px; color:#aaa;">Proyectos Permitidos:</div>
            <div id="checklistProyectos" style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-bottom:10px;"></div>
            <button class="btn btn-blue" onclick="guardarUsuario()">GUARDAR USUARIO</button>
        </div>
        <div style="flex:1; overflow-y:auto;">
            <h3 style="margin:0 0 10px 0; font-size:12px; color:var(--gray);">USUARIOS ACTIVOS</h3>
            <ul id="listaUsuarios"></ul>
        </div>
    </div>
</div>

<div class="top-bar">
    <div>
        <div style="font-size:12px; color:var(--gray); font-weight:600;">PATRIMONIO VISIBLE</div>
        <div class="big-number" id="totalPatrimonio">---</div>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="btn btn-blue" id="btnAdmin" style="display:none; width:auto; padding:10px 20px;" onclick="abrirAdmin()">‚öôÔ∏è USUARIOS</button>
        <button class="btn btn-green" style="width:auto; padding:10px 20px;" onclick="openModal('ingreso')">‚¨Ü INGRESAR</button>
        <button class="btn btn-red" style="width:auto; padding:10px 20px;" onclick="openModal('gasto')">‚¨á GASTAR</button>
        <button class="btn" style="width:auto; background:#333; color:#fff;" onclick="logout()">üîì SALIR</button>
    </div>
</div>

<div id="radar-alertas"></div>

<div class="grid">
    <div class="card">
        <h2>üè¶ Cuentas</h2>
        <div id="listCuentas"></div>
        <button class="btn btn-blue" onclick="crearCuenta()">+ Nueva Cuenta</button>
    </div>
    <div class="card">
        <h2>üöÄ Mis Proyectos</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;" id="gridActivos"></div>
        <div style="flex:1; border-top:1px solid #222; padding-top:10px;">
            <canvas id="chartActivos"></canvas>
        </div>
        <button class="btn btn-blue" id="btnAddProy" style="display:none;" onclick="crearActivo()">+ Nuevo Proyecto</button>
    </div>
    <div class="card">
        <h2>üìù Auditor√≠a de Movimientos</h2>
        <ul id="listMovs"></ul>
    </div>
</div>

<div id="modal">
    <div class="modal-box">
        <h2 id="modalTitle" style="color:var(--text); border:none;">Registrar</h2>
        <label>Descripci√≥n</label><input type="text" id="desc">
        <div class="form-row">
            <div style="flex:1"><label>Monto ($)</label><input type="number" id="monto"></div>
            <div style="flex:1"><label>Tipo</label><input type="text" id="tipoTxt" readonly style="color:#888;"></div>
        </div>
        
        <div id="divReembolso" class="checkbox-wrapper" style="display:none;">
            <input type="checkbox" id="chkReembolso" style="width:auto; margin:0;">
            <label for="chkReembolso" style="color:var(--yellow); font-size:12px; margin:0;">‚ö†Ô∏è Marcar como "Esperando Reembolso"</label>
        </div>

        <label>Cuenta</label><select id="selCuenta"></select>
        <label>Proyecto</label><select id="selActivo"></select>
        <div class="form-row" style="margin-top:20px;">
            <button class="btn btn-green" onclick="guardarMovimiento()">GUARDAR</button>
            <button class="btn btn-red" onclick="closeModal()">CANCELAR</button>
        </div>
    </div>
</div>

<script>
const $ = id => document.getElementById(id);
let DATA = { cuentas:[], activos:[], movimientos:[], pendientes:[] };
let CURRENT_USER = '';
let IS_ADMIN = false;
let currentTipo = 'ingreso';
let chartRef;

// --- LOGIN ---
async function doLogin() {
    const user = $('user').value; const pass = $('pass').value;
    try {
        const res = await fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user,pass})});
        const data = await res.json();
        if (data.success) { 
            CURRENT_USER = data.user; 
            IS_ADMIN = data.es_admin; // Boolean
            $('login-overlay').style.display='none'; 
            loadData(); 
        } else { $('loginError').style.display='block'; }
    } catch(e) { alert("Error Conexi√≥n"); }
}
function logout() { location.reload(); }

// --- DATA & RENDER ---
async function loadData() {
    try {
        const res = await fetch(`/api/data?user=${CURRENT_USER}`); 
        DATA = await res.json();
        renderAll();
    } catch(e) { console.error("Error cargando"); }
}

function renderAll() {
    // 1. Mostrar/Ocultar controles Admin
    if(IS_ADMIN) {
        $('btnAdmin').style.display = 'flex';
        $('btnAddProy').style.display = 'block';
        $('totalPatrimonio').innerText = fmtMoney(DATA.patrimonio);
    } else {
        $('totalPatrimonio').innerText = 'üîí Oculto'; // Empleado no ve patrimonio total
    }

    // 2. Radar de Reembolsos (Vital para Mercado Libre)
    const radar = $('radar-alertas');
    radar.innerHTML = '';
    if(DATA.pendientes && DATA.pendientes.length > 0) {
        radar.style.display = 'flex';
        DATA.pendientes.forEach(m => {
            const item = document.createElement('div');
            item.className = 'alerta-item';
            item.innerHTML = `
                <div>
                    <strong>‚ö†Ô∏è REEMBOLSO PENDIENTE: ${fmtMoney(Math.abs(m.monto))}</strong><br>
                    <span style="font-size:11px;">${m.descripcion} (${m.activo_id?.nombre}) - Creado por ${m.creado_por}</span>
                </div>
                <button class="btn btn-green" style="padding:5px 10px; width:auto;" onclick="confirmarReembolso('${m._id}')">‚úÖ CONFIRMAR LLEGADA</button>
            `;
            radar.appendChild(item);
        });
    } else {
        radar.style.display = 'none';
    }

    // 3. Listas Normales
    $('listCuentas').innerHTML = DATA.cuentas.map(c => `<div style="background:#1a1a1a; padding:15px; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;"><span>${c.icono} ${c.nombre}</span><span style="font-weight:bold;">${fmtMoney(c.saldo)}</span></div>`).join('');
    
    $('gridActivos').innerHTML = DATA.activos.map(a => `<div style="background:#151515; border:1px solid #333; padding:10px; border-radius:8px;"><div style="font-size:11px; color:#888;">${a.icono} ${a.nombre}</div><div style="font-size:15px; font-weight:bold; color:${a.balance_total>=0?'var(--green)':'var(--red)'}">${fmtMoney(a.balance_total)}</div></div>`).join('');
    
    // Lista de movimientos con firma de autor
    $('listMovs').innerHTML = DATA.movimientos.map(m => {
        let color = m.tipo=='ingreso'?'var(--green)':'var(--red)';
        if(m.estado === 'pendiente_reembolso') color = 'var(--yellow)';
        if(m.estado === 'reembolsado') color = '#555'; // Gris si ya fue devuelto

        return `
        <li style="opacity:${m.estado==='reembolsado'?0.5:1}">
            <div>
                <span style="display:block; font-size:13px; font-weight:600;">${m.descripcion} ${m.estado==='reembolsado'?'(DEVUELTO)':''}</span>
                <span class="meta-info">üë§ ${m.creado_por} | üìÇ ${m.activo_id?m.activo_id.nombre:'General'}</span>
            </div>
            <span style="font-weight:bold; color:${color}">
                ${m.tipo=='ingreso'?'+':''}${fmtMoney(m.monto)}
            </span>
        </li>`
    }).join('');
    
    updateChart(); populateSelects();
}

// --- LOGICA REEMBOLSOS ---
async function confirmarReembolso(id) {
    if(!confirm("¬øConfirmas que el dinero YA LLEG√ì a la cuenta?")) return;
    await fetch('/api/confirmar-reembolso', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ mov_id: id, usuario_actual: CURRENT_USER })
    });
    loadData();
}

// --- GESTION USUARIOS ---
async function abrirAdmin() {
    $('admin-overlay').style.display='flex';
    cargarUsuariosUI();
}
async function cargarUsuariosUI() {
    const res = await fetch('/api/usuarios');
    const users = await res.json();
    
    // Checklist de proyectos disponibles para asignar
    $('checklistProyectos').innerHTML = DATA.activos.map(a => `
        <div style="display:flex; align-items:center; gap:5px;">
            <input type="checkbox" class="chk-proy" value="${a._id}"> <span style="font-size:12px; color:#aaa;">${a.nombre}</span>
        </div>
    `).join('');

    $('listaUsuarios').innerHTML = users.map(u => `
        <li style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <strong style="color:${u.es_admin?'var(--green)':'#fff'}">${u.user} ${u.es_admin?'(ADMIN)':''}</strong>
                <div style="font-size:10px; color:#666;">Permisos: ${u.proyectos_permitidos.map(p=>p.nombre).join(', ') || 'Ninguno'}</div>
            </div>
            ${!u.es_admin ? `<button class="btn btn-red" style="padding:5px;" onclick="borrarUsuario('${u._id}')">üóëÔ∏è</button>` : ''}
        </li>
    `).join('');
}
async function guardarUsuario() {
    const user = $('new_user').value;
    const pass = $('new_pass').value;
    // Obtener proyectos marcados
    const checkboxes = document.querySelectorAll('.chk-proy:checked');
    const proyectos = Array.from(checkboxes).map(c => c.value);

    if(!user || !pass) return alert("Falta usuario o contrase√±a");

    await fetch('/api/usuarios', {
        method: 'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'crear', user, pass, proyectos })
    });
    $('new_user').value = ''; $('new_pass').value = '';
    cargarUsuariosUI();
}
async function borrarUsuario(id) {
    if(confirm("¬øEliminar usuario?")) {
        await fetch('/api/usuarios', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ action:'borrar', id }) });
        cargarUsuariosUI();
    }
}

// --- ACCIONES GENERALES ---
async function guardarMovimiento() {
    const desc = $('desc').value; const monto = parseFloat($('monto').value);
    const cuenta_id = $('selCuenta').value; const activo_id = $('selActivo').value || null;
    const esReembolso = $('chkReembolso').checked;
    
    let estado = 'finalizado';
    if(currentTipo === 'gasto' && esReembolso) estado = 'pendiente_reembolso';

    if(!desc || !monto || !cuenta_id) return alert("Faltan datos");
    
    const res = await fetch('/api/movimiento', { 
        method:'POST', headers:{'Content-Type':'application/json'}, 
        body:JSON.stringify({ 
            descripcion:desc, monto, cuenta_id, activo_id, 
            tipo:currentTipo, estado, usuario_actual: CURRENT_USER 
        }) 
    });
    
    const json = await res.json();
    if(json.error) return alert("ERROR: " + json.error);

    closeModal(); loadData();
}

async function crearCuenta() { const n = prompt("Nombre Cuenta:"); if(n) { await fetch('/api/cuentas', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})}); loadData(); }}
async function crearActivo() { const n = prompt("Nombre Proyecto:"); if(n) { await fetch('/api/activos', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:n})}); loadData(); }}

const fmtMoney = num => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(num);
function openModal(t) { 
    currentTipo=t; 
    $('modal').style.display='flex'; 
    $('tipoTxt').value=t.toUpperCase(); 
    $('desc').value=''; $('monto').value=''; 
    
    // Mostrar checkbox de reembolso solo si es GASTO
    if(t === 'gasto') $('divReembolso').style.display = 'flex';
    else $('divReembolso').style.display = 'none';
    $('chkReembolso').checked = false;
}
function closeModal() { $('modal').style.display='none'; }
function populateSelects() {
    $('selCuenta').innerHTML = DATA.cuentas.map(c => `<option value="${c._id}">${c.nombre} ($${c.saldo})</option>`).join('');
    // Si soy admin veo opci√≥n "Personal", si no, solo los proyectos obligatorios
    if(IS_ADMIN) {
        $('selActivo').innerHTML = `<option value="">-- Personal --</option>` + DATA.activos.map(a => `<option value="${a._id}">${a.nombre}</option>`).join('');
    } else {
        $('selActivo').innerHTML = DATA.activos.map(a => `<option value="${a._id}">${a.nombre}</option>`).join('');
    }
}
function updateChart() {
    const ctx = $('chartActivos').getContext('2d'); if(chartRef) chartRef.destroy();
    const activos = DATA.activos.filter(a => a.balance_total > 0);
    chartRef = new Chart(ctx, { type:'doughnut', data:{ labels:activos.map(a=>a.nombre), datasets:[{data:activos.map(a=>a.balance_total), borderWidth:0, backgroundColor:['#00e676','#2979ff','#ff1744','#ffd700']}] }, options:{responsive:true, plugins:{legend:{position:'right', labels:{color:'#fff',boxWidth:10}}}} });
}
</script>
</body>
</html>
